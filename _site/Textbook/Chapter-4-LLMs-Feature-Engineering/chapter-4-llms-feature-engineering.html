<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Chapter 4: LLMs for Feature Engineering and Data Extraction – MATH 3339: Introduction to Data Science with LLMs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles/textbook-nav.css">
</head>

<body class="quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#chapter-resources" id="toc-chapter-resources" class="nav-link active" data-scroll-target="#chapter-resources">Chapter Resources</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#the-feature-engineering-challenge-from-text-to-numbers" id="toc-the-feature-engineering-challenge-from-text-to-numbers" class="nav-link" data-scroll-target="#the-feature-engineering-challenge-from-text-to-numbers">1. The Feature Engineering Challenge: From Text to Numbers</a>
  <ul class="collapse">
  <li><a href="#why-traditional-ml-needs-structured-features" id="toc-why-traditional-ml-needs-structured-features" class="nav-link" data-scroll-target="#why-traditional-ml-needs-structured-features">1.1 Why Traditional ML Needs Structured Features</a></li>
  <li><a href="#what-information-is-hidden-in-text" id="toc-what-information-is-hidden-in-text" class="nav-link" data-scroll-target="#what-information-is-hidden-in-text">1.2 What Information Is Hidden in Text?</a></li>
  <li><a href="#traditional-nlp-approaches" id="toc-traditional-nlp-approaches" class="nav-link" data-scroll-target="#traditional-nlp-approaches">1.3 Traditional NLP Approaches</a></li>
  <li><a href="#the-llm-advantage-zero-shot-extraction" id="toc-the-llm-advantage-zero-shot-extraction" class="nav-link" data-scroll-target="#the-llm-advantage-zero-shot-extraction">1.4 The LLM Advantage: Zero-Shot Extraction</a></li>
  </ul></li>
  <li><a href="#your-first-llm-extraction-sentiment-analysis" id="toc-your-first-llm-extraction-sentiment-analysis" class="nav-link" data-scroll-target="#your-first-llm-extraction-sentiment-analysis">2. Your First LLM Extraction: Sentiment Analysis</a>
  <ul class="collapse">
  <li><a href="#setting-up-api-access" id="toc-setting-up-api-access" class="nav-link" data-scroll-target="#setting-up-api-access">2.1 Setting Up API Access</a></li>
  <li><a href="#making-your-first-extraction-call" id="toc-making-your-first-extraction-call" class="nav-link" data-scroll-target="#making-your-first-extraction-call">2.2 Making Your First Extraction Call</a></li>
  <li><a href="#understanding-the-api-call" id="toc-understanding-the-api-call" class="nav-link" data-scroll-target="#understanding-the-api-call">2.3 Understanding the API Call</a></li>
  <li><a href="#handling-errors-and-edge-cases" id="toc-handling-errors-and-edge-cases" class="nav-link" data-scroll-target="#handling-errors-and-edge-cases">2.4 Handling Errors and Edge Cases</a></li>
  </ul></li>
  <li><a href="#prompt-engineering-for-reliable-extraction" id="toc-prompt-engineering-for-reliable-extraction" class="nav-link" data-scroll-target="#prompt-engineering-for-reliable-extraction">3. Prompt Engineering for Reliable Extraction</a>
  <ul class="collapse">
  <li><a href="#the-anatomy-of-a-good-extraction-prompt" id="toc-the-anatomy-of-a-good-extraction-prompt" class="nav-link" data-scroll-target="#the-anatomy-of-a-good-extraction-prompt">3.1 The Anatomy of a Good Extraction Prompt</a></li>
  <li><a href="#requesting-structured-output-json" id="toc-requesting-structured-output-json" class="nav-link" data-scroll-target="#requesting-structured-output-json">3.2 Requesting Structured Output (JSON)</a></li>
  <li><a href="#few-shot-learning-teaching-by-example" id="toc-few-shot-learning-teaching-by-example" class="nav-link" data-scroll-target="#few-shot-learning-teaching-by-example">3.3 Few-Shot Learning: Teaching by Example</a></li>
  <li><a href="#iterating-on-prompts-a-real-example" id="toc-iterating-on-prompts-a-real-example" class="nav-link" data-scroll-target="#iterating-on-prompts-a-real-example">3.4 Iterating on Prompts: A Real Example</a></li>
  </ul></li>
  <li><a href="#parsing-validating-and-converting-to-dataframes" id="toc-parsing-validating-and-converting-to-dataframes" class="nav-link" data-scroll-target="#parsing-validating-and-converting-to-dataframes">4. Parsing, Validating, and Converting to DataFrames</a>
  <ul class="collapse">
  <li><a href="#parsing-json-responses" id="toc-parsing-json-responses" class="nav-link" data-scroll-target="#parsing-json-responses">4.1 Parsing JSON Responses</a></li>
  <li><a href="#validating-extractions" id="toc-validating-extractions" class="nav-link" data-scroll-target="#validating-extractions">4.2 Validating Extractions</a></li>
  <li><a href="#batch-processing-multiple-texts" id="toc-batch-processing-multiple-texts" class="nav-link" data-scroll-target="#batch-processing-multiple-texts">4.3 Batch Processing Multiple Texts</a></li>
  <li><a href="#converting-to-pandas-dataframe" id="toc-converting-to-pandas-dataframe" class="nav-link" data-scroll-target="#converting-to-pandas-dataframe">4.4 Converting to pandas DataFrame</a></li>
  </ul></li>
  <li><a href="#integration-with-ml-pipelines" id="toc-integration-with-ml-pipelines" class="nav-link" data-scroll-target="#integration-with-ml-pipelines">5. Integration with ML Pipelines</a>
  <ul class="collapse">
  <li><a href="#the-complete-pipeline-text-features-model" id="toc-the-complete-pipeline-text-features-model" class="nav-link" data-scroll-target="#the-complete-pipeline-text-features-model">5.1 The Complete Pipeline: Text → Features → Model</a></li>
  <li><a href="#encoding-and-training" id="toc-encoding-and-training" class="nav-link" data-scroll-target="#encoding-and-training">5.2 Encoding and Training</a></li>
  <li><a href="#avoiding-data-leakage-with-llm-features" id="toc-avoiding-data-leakage-with-llm-features" class="nav-link" data-scroll-target="#avoiding-data-leakage-with-llm-features">5.3 Avoiding Data Leakage with LLM Features</a></li>
  <li><a href="#comparing-with-and-without-llm-features" id="toc-comparing-with-and-without-llm-features" class="nav-link" data-scroll-target="#comparing-with-and-without-llm-features">5.4 Comparing With and Without LLM Features</a></li>
  </ul></li>
  <li><a href="#cost-analysis-and-provider-comparison" id="toc-cost-analysis-and-provider-comparison" class="nav-link" data-scroll-target="#cost-analysis-and-provider-comparison">6. Cost Analysis and Provider Comparison</a>
  <ul class="collapse">
  <li><a href="#understanding-token-based-pricing" id="toc-understanding-token-based-pricing" class="nav-link" data-scroll-target="#understanding-token-based-pricing">6.1 Understanding Token-Based Pricing</a></li>
  <li><a href="#calculating-extraction-costs" id="toc-calculating-extraction-costs" class="nav-link" data-scroll-target="#calculating-extraction-costs">6.2 Calculating Extraction Costs</a></li>
  <li><a href="#when-to-use-which-model" id="toc-when-to-use-which-model" class="nav-link" data-scroll-target="#when-to-use-which-model">6.3 When to Use Which Model</a></li>
  <li><a href="#roi-analysis-llm-vs.-alternatives" id="toc-roi-analysis-llm-vs.-alternatives" class="nav-link" data-scroll-target="#roi-analysis-llm-vs.-alternatives">6.4 ROI Analysis: LLM vs.&nbsp;Alternatives</a></li>
  </ul></li>
  <li><a href="#quality-control-and-validation" id="toc-quality-control-and-validation" class="nav-link" data-scroll-target="#quality-control-and-validation">7. Quality Control and Validation</a>
  <ul class="collapse">
  <li><a href="#measuring-extraction-accuracy" id="toc-measuring-extraction-accuracy" class="nav-link" data-scroll-target="#measuring-extraction-accuracy">7.1 Measuring Extraction Accuracy</a></li>
  <li><a href="#spot-checking-and-manual-review" id="toc-spot-checking-and-manual-review" class="nav-link" data-scroll-target="#spot-checking-and-manual-review">7.2 Spot-Checking and Manual Review</a></li>
  <li><a href="#identifying-systematic-errors" id="toc-identifying-systematic-errors" class="nav-link" data-scroll-target="#identifying-systematic-errors">7.3 Identifying Systematic Errors</a></li>
  <li><a href="#when-extraction-quality-is-good-enough" id="toc-when-extraction-quality-is-good-enough" class="nav-link" data-scroll-target="#when-extraction-quality-is-good-enough">7.4 When Extraction Quality Is “Good Enough”</a></li>
  </ul></li>
  <li><a href="#when-to-use-llms-vs.-traditional-nlp" id="toc-when-to-use-llms-vs.-traditional-nlp" class="nav-link" data-scroll-target="#when-to-use-llms-vs.-traditional-nlp">8. When to Use LLMs vs.&nbsp;Traditional NLP</a>
  <ul class="collapse">
  <li><a href="#decision-framework" id="toc-decision-framework" class="nav-link" data-scroll-target="#decision-framework">8.1 Decision Framework</a></li>
  <li><a href="#simple-regex-vs.-llm-a-comparison" id="toc-simple-regex-vs.-llm-a-comparison" class="nav-link" data-scroll-target="#simple-regex-vs.-llm-a-comparison">8.2 Simple Regex vs.&nbsp;LLM: A Comparison</a></li>
  <li><a href="#cost-benefit-comparison-table" id="toc-cost-benefit-comparison-table" class="nav-link" data-scroll-target="#cost-benefit-comparison-table">8.3 Cost-Benefit Comparison Table</a></li>
  <li><a href="#hybrid-approaches" id="toc-hybrid-approaches" class="nav-link" data-scroll-target="#hybrid-approaches">8.4 Hybrid Approaches</a></li>
  </ul></li>
  <li><a href="#practical-considerations-and-best-practices" id="toc-practical-considerations-and-best-practices" class="nav-link" data-scroll-target="#practical-considerations-and-best-practices">9. Practical Considerations and Best Practices</a>
  <ul class="collapse">
  <li><a href="#rate-limiting-and-api-quotas" id="toc-rate-limiting-and-api-quotas" class="nav-link" data-scroll-target="#rate-limiting-and-api-quotas">9.1 Rate Limiting and API Quotas</a></li>
  <li><a href="#error-handling-and-retries" id="toc-error-handling-and-retries" class="nav-link" data-scroll-target="#error-handling-and-retries">9.2 Error Handling and Retries</a></li>
  <li><a href="#caching-results-to-avoid-reprocessing" id="toc-caching-results-to-avoid-reprocessing" class="nav-link" data-scroll-target="#caching-results-to-avoid-reprocessing">9.3 Caching Results to Avoid Reprocessing</a></li>
  <li><a href="#logging-and-monitoring" id="toc-logging-and-monitoring" class="nav-link" data-scroll-target="#logging-and-monitoring">9.4 Logging and Monitoring</a></li>
  </ul></li>
  <li><a href="#real-world-example-complete-pipeline" id="toc-real-world-example-complete-pipeline" class="nav-link" data-scroll-target="#real-world-example-complete-pipeline">10. Real-World Example: Complete Pipeline</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#practice-exercises" id="toc-practice-exercises" class="nav-link" data-scroll-target="#practice-exercises">Practice Exercises</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">
<nav class="chapter-nav" aria-label="Textbook navigation">
  <a class="chapter-nav__link" href="https://paulsavala.github.io/math-3339-intro-data-science-with-llms/" aria-label="Course home" title="Course home">
    <i class="bi bi-house"></i>
  </a>
  <a class="chapter-nav__link" href="../table-of-contents.html" aria-label="Table of contents" title="Table of contents">
    <i class="bi bi-list"></i>
  </a>
</nav>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Chapter 4: LLMs for Feature Engineering and Data Extraction</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="chapter-resources" class="level2">
<h2 class="anchored" data-anchor-id="chapter-resources">Chapter Resources</h2>
<p><strong>Related Assignments:</strong></p>
<ul>
<li><a href="../../Assignments/Chapter 4 - LLMs Feature Engineering/chapter-4-homework.qmd">Chapter 4 Homework</a></li>
</ul>
<hr>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>You’ve spent weeks learning how to build machine learning models—linear regression, logistic regression, random forests, SVMs. You know how to tune hyperparameters, evaluate performance, and diagnose problems. But here’s the thing: all those models need one critical ingredient before they can work their magic.</p>
<p><strong>Features.</strong></p>
<p>And not just any features—numeric or categorical features that capture the information hidden in your data. If you have structured data (age, income, house size), you’re set. But what about unstructured data? What about customer reviews, support tickets, job descriptions, social media posts, news articles? Most real-world data lives in text, and traditional machine learning models can’t directly consume text.</p>
<p>This is where Large Language Models (LLMs) come in—not as the end goal, but as powerful <strong>feature engineering tools</strong>. Think of LLMs as intelligent extractors that can read text, understand context, and pull out structured information. Need to know if a review is positive or negative? LLM. Want to extract job requirements from a posting? LLM. Need to categorize thousands of support tickets? LLM.</p>
<p>The beautiful part? You don’t need to train these models. You don’t need GPUs. You don’t even need to understand how they work internally. You just call an API, send some text with instructions, and get back structured data ready for your ML pipeline.</p>
<p>But LLMs aren’t free, and they aren’t perfect. Every API call costs money. Extraction quality varies. Some tasks work beautifully with simpler versions of LLMs, such as GPT-4o, Gemini Flash, Claude Haiku, while others need more powerful models like GPT-5, Gemini Pro, or Claude Sonnet. Sometimes a simple regex pattern works better than an expensive LLM call. The skill isn’t just using LLMs—it’s knowing <strong>when</strong> to use them, <strong>which</strong> one to use, and <strong>how</strong> to validate the results.</p>
<p>This chapter teaches you to use LLMs as practical data science tools. You’ll learn to write prompts that extract information reliably, parse and validate LLM responses, calculate costs, integrate extracted features into ML pipelines, and most importantly—judge when LLMs add value versus when simpler approaches suffice.</p>
<p>Let’s jump in.</p>
<hr>
</section>
<section id="the-feature-engineering-challenge-from-text-to-numbers" class="level2">
<h2 class="anchored" data-anchor-id="the-feature-engineering-challenge-from-text-to-numbers">1. The Feature Engineering Challenge: From Text to Numbers</h2>
<section id="why-traditional-ml-needs-structured-features" class="level3">
<h3 class="anchored" data-anchor-id="why-traditional-ml-needs-structured-features">1.1 Why Traditional ML Needs Structured Features</h3>
<p>Remember our housing price predictor from earlier chapters? The input was clean: square footage (numeric), number of bedrooms (numeric), neighborhood (categorical). Easy. Train-test split, fit the model, done.</p>
<p>But look at this product review:</p>
<blockquote class="blockquote">
<p>“This coffee maker is amazing! Brews quickly and the coffee tastes great. Only downside is it’s a bit loud, but I can live with that for this price.”</p>
</blockquote>
<p>What features can we extract? What information is hidden here that might help predict if other customers will find this review helpful?</p>
<div id="48037357" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Product review data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>review_text <span class="op">=</span> <span class="st">"This coffee maker is amazing! Brews quickly and the coffee tastes great. Only downside is it's a bit loud, but I can live with that for this price."</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Traditional ML needs numbers or categories</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># We could count words, but that misses the meaning</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>word_count <span class="op">=</span> <span class="bu">len</span>(review_text.split())</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Word count: </span><span class="sc">{</span>word_count<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># We could look for specific keywords</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>has_positive_words <span class="op">=</span> <span class="bu">any</span>(word <span class="kw">in</span> review_text.lower() <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'amazing'</span>, <span class="st">'great'</span>, <span class="st">'love'</span>])</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>has_negative_words <span class="op">=</span> <span class="bu">any</span>(word <span class="kw">in</span> review_text.lower() <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'bad'</span>, <span class="st">'terrible'</span>, <span class="st">'hate'</span>])</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Has positive words: </span><span class="sc">{</span>has_positive_words<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Has negative words: </span><span class="sc">{</span>has_negative_words<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># But we're missing so much: </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># - sentiment nuance</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># - specific features mentioned</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># - overall tone</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># - ...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Word count: 28
Has positive words: True
Has negative words: False</code></pre>
</div>
</div>
<p>Word counts and keyword matching capture some information, but they miss the <strong>meaning</strong>. This review is mostly positive despite mentioning a downside. A keyword approach might rate it as mixed because it has both positive and negative words. But a human reading it understands: this person likes the product.</p>
</section>
<section id="what-information-is-hidden-in-text" class="level3">
<h3 class="anchored" data-anchor-id="what-information-is-hidden-in-text">1.2 What Information Is Hidden in Text?</h3>
<p>Text contains structured information waiting to be extracted:</p>
<p><strong>Sentiment/Opinion:</strong></p>
<ul>
<li>Overall positive/negative/neutral</li>
<li>Strength of sentiment (mildly positive vs.&nbsp;extremely positive)</li>
<li>Sentiment about specific aspects (loves taste, dislikes noise)</li>
</ul>
<p><strong>Categories/Classification:</strong></p>
<ul>
<li>Product category (coffee maker, not coffee beans)</li>
<li>Issue type in support tickets (billing vs.&nbsp;technical)</li>
<li>Job seniority level (entry vs.&nbsp;senior)</li>
</ul>
<p><strong>Entities and Attributes:</strong></p>
<ul>
<li>Brands mentioned</li>
<li>Specific features discussed (speed, taste, noise)</li>
<li>Requirements (in job postings: “5 years experience”, “Python required”)</li>
</ul>
<p><strong>Numeric Values:</strong></p>
<ul>
<li>Implicit ratings (“amazing” = 5 stars, “okay” = 3 stars)</li>
<li>Quantities mentioned</li>
<li>Price ranges</li>
</ul>
</section>
<section id="traditional-nlp-approaches" class="level3">
<h3 class="anchored" data-anchor-id="traditional-nlp-approaches">1.3 Traditional NLP Approaches</h3>
<p>Before LLMs, we had a few options:</p>
<p><strong>1. Keyword/Regex Matching:</strong></p>
<p>This approach attempts to search for specific keywords in the text. For example, look at the <code>positive_words</code> and <code>negative_words</code> in the code below.</p>
<div id="618306d8" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simple_sentiment(text):</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Basic sentiment using keyword matching"""</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    positive_words <span class="op">=</span> [<span class="st">'amazing'</span>, <span class="st">'great'</span>, <span class="st">'excellent'</span>, <span class="st">'love'</span>, <span class="st">'perfect'</span>]</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    negative_words <span class="op">=</span> [<span class="st">'bad'</span>, <span class="st">'terrible'</span>, <span class="st">'hate'</span>, <span class="st">'awful'</span>, <span class="st">'waste'</span>]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    text_lower <span class="op">=</span> text.lower()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    pos_count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> word <span class="kw">in</span> positive_words <span class="cf">if</span> word <span class="kw">in</span> text_lower)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    neg_count <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> word <span class="kw">in</span> negative_words <span class="cf">if</span> word <span class="kw">in</span> text_lower)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pos_count <span class="op">&gt;</span> neg_count:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"positive"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> neg_count <span class="op">&gt;</span> pos_count:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"negative"</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"neutral"</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>review <span class="op">=</span> <span class="st">"This coffee maker is amazing! Brews quickly and the coffee tastes great."</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Simple sentiment: </span><span class="sc">{</span>simple_sentiment(review)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple sentiment: positive</code></pre>
</div>
</div>
<p><strong>When to use this:</strong></p>
<ul>
<li>When you have specific words you’re looking for, such as students mentioning a specific course</li>
</ul>
<p><strong>When this fails:</strong></p>
<ul>
<li>This works for simple cases but breaks easily:
<ul>
<li>“This product is not bad” → Incorrectly classified as negative</li>
<li>“I expected amazing quality but got terrible service” → Confusing mix</li>
<li>Doesn’t handle sarcasm, context, or nuance</li>
</ul></li>
</ul>
<p><strong>2. Bag-of-Words + ML:</strong> “Bag of words” is a simple way to represent text as a vector of word counts. For example, we might assign:</p>
<ul>
<li>“apple” = 0</li>
<li>“banana” = 1</li>
<li>“orange” = 2</li>
</ul>
<p>These number represent the <em>index</em> of each word in our vector. So “apple” is at index 0, “banana” is at index 1, and “orange” is at index 2. Then we might count up how many times each word appears in the text. For example, the text “I have an apple and a banana” would be represented as [1, 1, 0] (“apple” apears once as indicated in index zero, and “banana” appears once, but “orange” never appears).</p>
<p>This gives us numeric values, which can then be used in any of the machine learning models you’ve learned so far this semester.</p>
<p>Problems with this approach include:</p>
<ul>
<li>Need a large labeled dataset, which is expensive to create</li>
<li>Need to retrain for new domains (i.e.&nbsp;the dataset you have may not cover the domain you’re interested in)</li>
<li>Separate model for each extraction task (i.e.&nbsp;you need a separate model for each feature you want to extract, such as sentiment, brand, price, etc.)</li>
</ul>
<p><strong>3. Other approaches:</strong> Traditionally, people used many, many different approaches for feature extraction, such as TF-IDF, word embeddings, and more. These approaches were often ad-hoc and required a lot of expertise to implement.</p>
<p>Once LLMs arose, people quickly realized that we can simply <em>ask the LLM</em> to extract what we want. While not always perfect, this approach is highly flexible, tuneable, and easily implemented. Because of that, we’ll focus the majority of our efforts on this technique.</p>
</section>
<section id="the-llm-advantage-zero-shot-extraction" class="level3">
<h3 class="anchored" data-anchor-id="the-llm-advantage-zero-shot-extraction">1.4 The LLM Advantage: Zero-Shot Extraction</h3>
<p>LLMs offer something revolutionary: <strong>zero-shot learning</strong>, which means that you can extract information without training on your specific task, without labeled data, just by asking clearly.</p>
<p>Here’s a preview (we’ll implement this properly soon):</p>
<blockquote class="blockquote">
<p><strong>Prompt:</strong> “What is the sentiment of this review? Answer with just ‘positive’, ‘negative’, or ‘neutral’: This coffee maker is amazing! Brews quickly and the coffee tastes great. Only downside is it’s a bit loud.”</p>
<p><strong>LLM Response:</strong> “positive”</p>
</blockquote>
<p>No training. No labeled data. Just clear instructions and the text. The LLM understands context, handles negation, grasps nuance. It knows “only downside” indicates a minor criticism in an otherwise positive review.</p>
<p>This is powerful. But it’s also expensive, sometimes inconsistent, and not always necessary. In addition, it’s clearly a black box, since we have no idea how the LLM decided this should be a positive review. Of course, we could continually tweak instructions to get outcomes closer to what we want. This is the art and science of working with LLMs.</p>
<hr>
</section>
</section>
<section id="your-first-llm-extraction-sentiment-analysis" class="level2">
<h2 class="anchored" data-anchor-id="your-first-llm-extraction-sentiment-analysis">2. Your First LLM Extraction: Sentiment Analysis</h2>
<section id="setting-up-api-access" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-api-access">2.1 Setting Up API Access</h3>
<p>To use LLMs, you need API access. The main options:</p>
<ul>
<li><strong>OpenAI (GPT-5):</strong> Most popular, good quality, moderate cost</li>
<li><strong>Anthropic (Claude):</strong> High quality, good for long texts, moderate cost</li>
<li><strong>Google (Gemini):</strong> Competitive quality, often cheaper</li>
<li><strong>Open-source via Hugging Face:</strong> Free but requires more setup</li>
</ul>
<p>For this chapter, we’ll use OpenAI’s API since it’s widely available. The concepts transfer to other providers.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>About Running These Examples:</strong> The code examples in this chapter that call the OpenAI API will require an API key to run. If you don’t have an API key set, the examples will be skipped during rendering. This is intentional - you can still learn from reading the code and understanding the patterns. When you’re ready to run these examples yourself:</p>
<ol type="1">
<li>Sign up for an OpenAI API account at <a href="https://platform.openai.com">platform.openai.com</a></li>
<li>Generate an API key</li>
<li>Set it as an environment variable: <code>export OPENAI_API_KEY="your-key-here"</code></li>
<li>Be mindful of costs - start with small tests before processing large datasets</li>
</ol>
</div>
</div>
<div id="9323271c" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, install the OpenAI library if needed</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pip install openai</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up your API key</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># IMPORTANT: Never hard-code API keys! Use environment variables</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set this in your terminal: export OPENAI_API_KEY="your-key-here"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if API key is set</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.getenv(<span class="st">"OPENAI_API_KEY"</span>) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"⚠️  API key not found. Set OPENAI_API_KEY environment variable."</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"⚠️  API calls in this chapter will be skipped."</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> OpenAI(api_key<span class="op">=</span>os.getenv(<span class="st">"OPENAI_API_KEY"</span>))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✓ API key is set"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>⚠️  API key not found. Set OPENAI_API_KEY environment variable.
⚠️  API calls in this chapter will be skipped.</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Never commit API keys to GitHub!</strong> Use environment variables or config files that are in <code>.gitignore</code>. Exposed keys can lead to unexpected charges or account suspension.</p>
</div>
</div>
</section>
<section id="making-your-first-extraction-call" class="level3">
<h3 class="anchored" data-anchor-id="making-your-first-extraction-call">2.2 Making Your First Extraction Call</h3>
<p>Let’s extract sentiment from a product review:</p>
<div id="64186383" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_sentiment_simple(review_text):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract sentiment using GPT-3.5</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns: 'positive', 'negative', or 'neutral'</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> client <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️  Skipping API call (no API key set)"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"neutral"</span>  <span class="co"># Default response</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the prompt</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""What is the sentiment of this review?</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ss">Answer with just one word: 'positive', 'negative', or 'neutral'.</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: </span><span class="sc">{</span>review_text<span class="sc">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="ss">Sentiment:"""</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call the API</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,  <span class="co"># Cheaper, faster model</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>[</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        temperature<span class="op">=</span><span class="dv">0</span>,  <span class="co"># Deterministic output</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        max_tokens<span class="op">=</span><span class="dv">10</span>   <span class="co"># We only need one word</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the response</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    sentiment <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip().lower()</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sentiment</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Test it (only if API key is available)</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    review1 <span class="op">=</span> <span class="st">"This coffee maker is amazing! Brews quickly and the coffee tastes great. Only downside is it's a bit loud."</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    review2 <span class="op">=</span> <span class="st">"Total waste of money. Broke after two uses. Terrible product."</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    review3 <span class="op">=</span> <span class="st">"It's okay. Does the job but nothing special."</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Review 1 sentiment: </span><span class="sc">{</span>extract_sentiment_simple(review1)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Review 2 sentiment: </span><span class="sc">{</span>extract_sentiment_simple(review2)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Review 3 sentiment: </span><span class="sc">{</span>extract_sentiment_simple(review3)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping examples - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Review 1 sentiment: positive"</span>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Review 2 sentiment: negative"</span>)</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Review 3 sentiment: neutral"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping examples - set OPENAI_API_KEY to run

Expected output when API key is set:
Review 1 sentiment: positive
Review 2 sentiment: negative
Review 3 sentiment: neutral</code></pre>
</div>
</div>
<p>We sent a clear instruction, included the text, and got back exactly what we asked for. No training, no labeled data, no complex preprocessing. Notice how the LLM correctly identifies Review 1 as positive despite it mentioning a downside—it understands that “only downside” indicates a minor complaint in an otherwise positive review.</p>
</section>
<section id="understanding-the-api-call" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-api-call">2.3 Understanding the API Call</h3>
<p>Let’s break down the important parameters:</p>
<p><strong>model:</strong> Which LLM to use</p>
<ul>
<li><code>gpt-3.5-turbo</code>: Cheaper ($0.0005 per 1K tokens), faster, good for most tasks</li>
<li><code>gpt-4</code>: More expensive ($0.03 per 1K tokens), smarter, better for complex extraction</li>
<li>Start with 3.5, upgrade to 4 if quality isn’t sufficient</li>
</ul>
<p><strong>temperature:</strong> Controls randomness (0 to 2)</p>
<ul>
<li><code>0</code>: Deterministic, same input → same output</li>
<li><code>0.7-1.0</code>: More creative/varied (for generation tasks)</li>
<li>For extraction: use <code>0</code> for consistency</li>
</ul>
<p><strong>max_tokens:</strong> Maximum length of response</p>
<ul>
<li>Tokens ≈ words × 1.3 (rough estimate)</li>
<li>For simple extraction: 10-50 tokens</li>
<li>For detailed extraction: 100-500 tokens</li>
<li>More tokens = higher cost</li>
</ul>
<div id="719e89b8" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's see token usage and cost</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: <span class="st">"What is 2+2?"</span>}],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        temperature<span class="op">=</span><span class="dv">0</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    usage <span class="op">=</span> response.usage</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Prompt tokens: </span><span class="sc">{</span>usage<span class="sc">.</span>prompt_tokens<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Completion tokens: </span><span class="sc">{</span>usage<span class="sc">.</span>completion_tokens<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total tokens: </span><span class="sc">{</span>usage<span class="sc">.</span>total_tokens<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate cost (GPT-3.5-turbo pricing as of 2024)</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    cost_per_1k_tokens <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    cost <span class="op">=</span> (usage.total_tokens <span class="op">/</span> <span class="dv">1000</span>) <span class="op">*</span> cost_per_1k_tokens</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cost for this call: $</span><span class="sc">{</span>cost<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Prompt tokens: 14"</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Completion tokens: 1"</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Total tokens: 15"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Cost for this call: $0.000008"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping - set OPENAI_API_KEY to run

Expected output when API key is set:
Prompt tokens: 14
Completion tokens: 1
Total tokens: 15
Cost for this call: $0.000008</code></pre>
</div>
</div>
<p>For our simple sentiment extraction, we’re using about 50-100 tokens per review. At $0.0005 per 1K tokens, that’s $0.00005 per review. To process 10,000 reviews: $0.50. Cheap!</p>
</section>
<section id="handling-errors-and-edge-cases" class="level3">
<h3 class="anchored" data-anchor-id="handling-errors-and-edge-cases">2.4 Handling Errors and Edge Cases</h3>
<p>LLMs don’t always follow instructions perfectly. Let’s make our extraction more robust:</p>
<div id="c7c1a066" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_sentiment_robust(review_text):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Robust sentiment extraction with error handling</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> <span class="ss">f"""What is the sentiment of this review?</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ss">Answer with ONLY one of these words: positive, negative, neutral</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: </span><span class="sc">{</span>review_text<span class="sc">}</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ss">Sentiment:"""</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">10</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        sentiment <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip().lower()</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate the response</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        valid_sentiments <span class="op">=</span> [<span class="st">'positive'</span>, <span class="st">'negative'</span>, <span class="st">'neutral'</span>]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> sentiment <span class="kw">in</span> valid_sentiments:</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> sentiment</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to extract valid sentiment from response</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> valid <span class="kw">in</span> valid_sentiments:</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> valid <span class="kw">in</span> sentiment:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> valid</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If we still can't find it, return None</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error during extraction: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with various inputs</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>reviews <span class="op">=</span> [</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Love it!"</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Terrible product."</span>,</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"It's fine."</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span>  <span class="co"># Empty review - will this break?</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> review <span class="kw">in</span> reviews:</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> extract_sentiment_robust(review)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"'</span><span class="sc">{</span>review<span class="sc">}</span><span class="ss">' → </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping examples - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"'Love it!' → positive"</span>)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"'Terrible product.' → negative"</span>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"'It's fine.' → neutral"</span>)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"'' → None"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping examples - set OPENAI_API_KEY to run

Expected output when API key is set:
'Love it!' → positive
'Terrible product.' → negative
'It's fine.' → neutral
'' → None</code></pre>
</div>
</div>
<p>Key improvements:</p>
<ol type="1">
<li><strong>Try-except block</strong> catches API errors</li>
<li><strong>Validation</strong> checks if response matches expected values</li>
<li><strong>Fallback logic</strong> tries to extract valid sentiment if response is wordy</li>
<li><strong>Returns None</strong> if extraction fails (rather than crashing)</li>
</ol>
<p>Notice how the function handles the empty review gracefully by returning <code>None</code> instead of crashing.</p>
<hr>
</section>
</section>
<section id="prompt-engineering-for-reliable-extraction" class="level2">
<h2 class="anchored" data-anchor-id="prompt-engineering-for-reliable-extraction">3. Prompt Engineering for Reliable Extraction</h2>
<section id="the-anatomy-of-a-good-extraction-prompt" class="level3">
<h3 class="anchored" data-anchor-id="the-anatomy-of-a-good-extraction-prompt">3.1 The Anatomy of a Good Extraction Prompt</h3>
<p>A good prompt has four parts:</p>
<ol type="1">
<li><strong>Clear task description:</strong> What do you want extracted?</li>
<li><strong>Output format specification:</strong> Exactly how should the response look?</li>
<li><strong>The input data:</strong> The text to analyze</li>
<li><strong>Any constraints or examples:</strong> Helps guide the LLM</li>
</ol>
<p>Let’s compare bad vs.&nbsp;good prompts:</p>
<div id="225751f4" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># BAD PROMPT - Vague, no format specified</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>bad_prompt <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st">Tell me about this review:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="sc">{review_text}</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># GOOD PROMPT - Clear, specific format</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>good_prompt <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="st">Extract the following information from this product review:</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="st">- Sentiment: positive, negative, or neutral</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="st">- Rating: estimated star rating from 1-5</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="st">- Main complaint: brief description, or "none" if no complaints</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">Format your response as JSON:</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="sc">{{</span><span class="st">"sentiment": "positive/negative/neutral", "rating": 1-5, "complaint": "text or none"</span><span class="sc">}}</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="st">Review: </span><span class="sc">{review_text}</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="st">JSON:"""</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>review <span class="op">=</span> <span class="st">"Great coffee maker! Makes excellent coffee quickly. Wish it was quieter though. 4 stars."</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co"># The good prompt will give us structured, parseable output</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>See the difference? The good prompt: - Lists exactly what to extract - Specifies valid values for each field - Requests JSON format for easy parsing - Shows the structure we expect</p>
</section>
<section id="requesting-structured-output-json" class="level3">
<h3 class="anchored" data-anchor-id="requesting-structured-output-json">3.2 Requesting Structured Output (JSON)</h3>
<p>JSON is your best friend for extraction. It’s easy to parse and works with any number of fields:</p>
<div id="52127d83" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_review_features(review_text):</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract multiple features from a review using JSON output</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> client <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️  Skipping API call (no API key set)"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""Extract information from this product review.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="ss">Respond with ONLY valid JSON in this exact format:</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    "sentiment": "positive/negative/neutral",</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    "rating": 1-5,</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    "pros": ["list", "of", "positive", "aspects"],</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    "cons": ["list", "of", "negative", "aspects"]</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: </span><span class="sc">{</span>review_text<span class="sc">}</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="ss">JSON:"""</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        temperature<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        max_tokens<span class="op">=</span><span class="dv">200</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse the JSON response</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        result_text <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip()</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sometimes LLMs add markdown formatting, remove it</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        result_text <span class="op">=</span> result_text.replace(<span class="st">'```json'</span>, <span class="st">''</span>).replace(<span class="st">'```'</span>, <span class="st">''</span>).strip()</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> json.loads(result_text)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError <span class="im">as</span> e:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed to parse JSON: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Raw response: </span><span class="sc">{</span>result_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Test it (only if API key is available)</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    review <span class="op">=</span> <span class="st">"""This coffee maker is fantastic! The coffee tastes amazing and</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="st">    it's very fast. Design is sleek. Only complaint is it's somewhat loud</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="st">    during brewing, but that's minor. Highly recommend!"""</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_review_features(review)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features:</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Extracted features:"</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(json.dumps(features, indent<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping example - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Extracted features:"</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"""{</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="st">  "sentiment": "positive",</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="st">  "rating": 4,</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="st">  "pros": [</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="st">    "Coffee tastes amazing",</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="st">    "Very fast",</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="st">    "Sleek design"</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="st">  ],</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="st">  "cons": [</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="st">    "Somewhat loud during brewing"</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="st">  ]</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="st">}"""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping example - set OPENAI_API_KEY to run

Expected output when API key is set:
Extracted features:
{
  "sentiment": "positive",
  "rating": 4,
  "pros": [
    "Coffee tastes amazing",
    "Very fast",
    "Sleek design"
  ],
  "cons": [
    "Somewhat loud during brewing"
  ]
}</code></pre>
</div>
</div>
<p>This gives us structured data we can immediately put into a DataFrame! Notice how the LLM extracted multiple pieces of information from a single review: overall sentiment, an estimated rating, specific positive aspects, and even the one complaint mentioned.</p>
</section>
<section id="few-shot-learning-teaching-by-example" class="level3">
<h3 class="anchored" data-anchor-id="few-shot-learning-teaching-by-example">3.3 Few-Shot Learning: Teaching by Example</h3>
<p>Sometimes clear instructions aren’t enough. LLMs learn better with examples:</p>
<div id="248dc1a2" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_with_examples(review_text):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Use few-shot learning - provide examples of correct extraction</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> client <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️  Skipping API call (no API key set)"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"neutral"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""Extract sentiment from product reviews.</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="ss">Examples:</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: "Best purchase ever! Love this product."</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="ss">Sentiment: positive</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: "Broke after one day. Waste of money."</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="ss">Sentiment: negative</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: "It's okay. Does what it says."</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="ss">Sentiment: neutral</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="ss">Now extract sentiment from this review:</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: </span><span class="sc">{</span>review_text<span class="sc">}</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="ss">Sentiment:"""</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        temperature<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        max_tokens<span class="op">=</span><span class="dv">10</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content.strip().lower()</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with tricky example (only if API key is available)</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    tricky_review <span class="op">=</span> <span class="st">"I wanted to love this, but it's just not good enough."</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    sentiment <span class="op">=</span> extract_with_examples(tricky_review)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Tricky review sentiment: </span><span class="sc">{</span>sentiment<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping example - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Tricky review sentiment: negative"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping example - set OPENAI_API_KEY to run

Expected output when API key is set:
Tricky review sentiment: negative</code></pre>
</div>
</div>
<p>Few-shot prompting (providing 2-5 examples) helps with: - Ambiguous edge cases - Specific formatting requirements - Consistency across similar inputs - Domain-specific language</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Few-Shot Prompting Best Practices:</strong> - Use 2-5 examples (more doesn’t always help) - Examples should cover different scenarios (positive, negative, neutral) - Keep examples concise - Examples cost tokens—balance quality vs.&nbsp;cost</p>
</div>
</div>
</section>
<section id="iterating-on-prompts-a-real-example" class="level3">
<h3 class="anchored" data-anchor-id="iterating-on-prompts-a-real-example">3.4 Iterating on Prompts: A Real Example</h3>
<p>Prompts rarely work perfectly the first time. Let’s iterate:</p>
<div id="10c1cf1f" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># V1: First attempt - too vague</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>prompt_v1 <span class="op">=</span> <span class="st">"What category is this job posting?"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># V2: More specific</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>prompt_v2 <span class="op">=</span> <span class="st">"""What job category is this posting?</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="st">Choose from: Engineering, Marketing, Sales, Customer Support, Other"""</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># V3: Even more specific with format</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>prompt_v3 <span class="op">=</span> <span class="st">"""Classify this job posting into ONE category.</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="st">Valid categories: Engineering, Marketing, Sales, Customer Support, Other</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with ONLY the category name, nothing else.</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="st">Job posting: </span><span class="sc">{text}</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="st">Category:"""</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co"># V4: Add examples for edge cases</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>prompt_v4 <span class="op">=</span> <span class="st">"""Classify this job posting into ONE category.</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="st">Valid categories: Engineering, Marketing, Sales, Customer Support, Other</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="st">Examples:</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="st">"Senior Python Developer needed" → Engineering</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="st">"Social Media Manager wanted" → Marketing</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="st">"Account Executive" → Sales</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="st">Job posting: </span><span class="sc">{text}</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="st">Category:"""</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co"># This iterative process is normal and expected</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Start simple, add specificity based on failures</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The key is testing your prompts on real data and refining based on errors. We’ll see more on validation in the next section.</p>
<hr>
</section>
</section>
<section id="parsing-validating-and-converting-to-dataframes" class="level2">
<h2 class="anchored" data-anchor-id="parsing-validating-and-converting-to-dataframes">4. Parsing, Validating, and Converting to DataFrames</h2>
<section id="parsing-json-responses" class="level3">
<h3 class="anchored" data-anchor-id="parsing-json-responses">4.1 Parsing JSON Responses</h3>
<p>Let’s build a robust system for extracting and parsing:</p>
<div id="09fb1d9f" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_job_features(job_text):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract structured information from job postings</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a dictionary or None if extraction fails</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> client <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️  Skipping API call (no API key set)"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""Extract these fields from the job posting.</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="ss">Respond with valid JSON:</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="ss">    "title": "job title",</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    "category": "Engineering/Marketing/Sales/Support/Other",</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="ss">    "experience_level": "Entry/Mid/Senior/Lead",</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="ss">    "remote_policy": "Remote/Hybrid/Onsite",</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="ss">    "key_skills": ["skill1", "skill2", "skill3"]</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="ss">Job posting: </span><span class="sc">{</span>job_text<span class="sc">}</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="ss">JSON:"""</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">300</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get response text</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        result_text <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip()</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean up markdown formatting if present</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        result_text <span class="op">=</span> result_text.replace(<span class="st">'```json'</span>, <span class="st">''</span>).replace(<span class="st">'```'</span>, <span class="st">''</span>).strip()</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse JSON</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> json.loads(result_text)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError <span class="im">as</span> e:</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"JSON parsing error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"API error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Test it (only if API key is available)</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    job_posting <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="st">    Senior Data Scientist - Remote</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="st">    We're seeking an experienced data scientist with 5+ years experience.</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="st">    Required: Python, SQL, machine learning, deep learning.</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="st">    Fully remote position.</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_job_features(job_posting)</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features:</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Extracted job features:"</span>)</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> key, value <span class="kw">in</span> features.items():</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping example - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Extracted job features:"</span>)</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  title: Senior Data Scientist"</span>)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  category: Engineering"</span>)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  experience_level: Senior"</span>)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  remote_policy: Remote"</span>)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  key_skills: ['Python', 'SQL', 'machine learning', 'deep learning']"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping example - set OPENAI_API_KEY to run

Expected output when API key is set:
Extracted job features:
  title: Senior Data Scientist
  category: Engineering
  experience_level: Senior
  remote_policy: Remote
  key_skills: ['Python', 'SQL', 'machine learning', 'deep learning']</code></pre>
</div>
</div>
</section>
<section id="validating-extractions" class="level3">
<h3 class="anchored" data-anchor-id="validating-extractions">4.2 Validating Extractions</h3>
<p>Always validate LLM outputs—they don’t always follow instructions:</p>
<div id="2b4763c1" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_job_features(features):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Validate that extracted features match expected format</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns True if valid, False otherwise</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define expected fields and valid values</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    expected_fields <span class="op">=</span> [<span class="st">'title'</span>, <span class="st">'category'</span>, <span class="st">'experience_level'</span>, <span class="st">'remote_policy'</span>, <span class="st">'key_skills'</span>]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    valid_categories <span class="op">=</span> [<span class="st">'Engineering'</span>, <span class="st">'Marketing'</span>, <span class="st">'Sales'</span>, <span class="st">'Support'</span>, <span class="st">'Other'</span>]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    valid_experience <span class="op">=</span> [<span class="st">'Entry'</span>, <span class="st">'Mid'</span>, <span class="st">'Senior'</span>, <span class="st">'Lead'</span>]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    valid_remote <span class="op">=</span> [<span class="st">'Remote'</span>, <span class="st">'Hybrid'</span>, <span class="st">'Onsite'</span>]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check all required fields present</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>(field <span class="kw">in</span> features <span class="cf">for</span> field <span class="kw">in</span> expected_fields):</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Missing required fields"</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check category is valid</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'category'</span>] <span class="kw">not</span> <span class="kw">in</span> valid_categories:</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Invalid category: </span><span class="sc">{</span>features[<span class="st">'category'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check experience level is valid</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'experience_level'</span>] <span class="kw">not</span> <span class="kw">in</span> valid_experience:</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Invalid experience level: </span><span class="sc">{</span>features[<span class="st">'experience_level'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check remote policy is valid</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> features[<span class="st">'remote_policy'</span>] <span class="kw">not</span> <span class="kw">in</span> valid_remote:</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Invalid remote policy: </span><span class="sc">{</span>features[<span class="st">'remote_policy'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check key_skills is a list</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(features[<span class="st">'key_skills'</span>], <span class="bu">list</span>):</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"key_skills should be a list"</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Test validation (only if we have features from previous cell)</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> client <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># features was defined in previous cell when client is not None</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    is_valid <span class="op">=</span> validate_job_features(features)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Validation result: </span><span class="sc">{</span>is_valid<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Skipping validation - set OPENAI_API_KEY to run"</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Expected output when API key is set:"</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Validation result: True"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Skipping validation - set OPENAI_API_KEY to run

Expected output when API key is set:
Validation result: True</code></pre>
</div>
</div>
<p>See what happened? All the extracted fields are in the expected format: category is one of the valid options, experience level is valid, remote policy is valid, and key_skills is a list. The validation passed!</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Never Trust LLM Output Blindly</strong> LLMs can: - Return invalid categories - Return wrong data types - Hallucinate information not in the text - Miss fields entirely</p>
<p>Always validate before using extracted features in ML models.</p>
</div>
</div>
</section>
<section id="batch-processing-multiple-texts" class="level3">
<h3 class="anchored" data-anchor-id="batch-processing-multiple-texts">4.3 Batch Processing Multiple Texts</h3>
<p>Real datasets have hundreds or thousands of texts. Let’s process them efficiently:</p>
<div id="7c6fc66f" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_batch(texts, extract_func, show_progress<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract features from multiple texts</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">        texts: List of text strings</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">        extract_func: Function that extracts features from one text</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">        show_progress: Whether to print progress</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">        List of extracted features (same length as texts)</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, text <span class="kw">in</span> <span class="bu">enumerate</span>(texts):</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> show_progress <span class="kw">and</span> (i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>):</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(texts)<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> extract_func(text)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        results.append(result)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Batch process multiple reviews</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>reviews <span class="op">=</span> [</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amazing product! Best purchase ever."</span>,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Terrible quality. Broke immediately."</span>,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"It's fine. Nothing special."</span>,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Great value for money!"</span>,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Disappointed with this purchase."</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: This would actually call the API multiple times</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll implement a more efficient version with error handling next</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>sentiments <span class="op">=</span> extract_batch(reviews, extract_sentiment_robust, show_progress<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Results:"</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> review, sentiment <span class="kw">in</span> <span class="bu">zip</span>(reviews, sentiments):</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"'</span><span class="sc">{</span>review[:<span class="dv">30</span>]<span class="sc">}</span><span class="ss">...' → </span><span class="sc">{</span>sentiment<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing 0/5...
Error during extraction: 'NoneType' object has no attribute 'chat'
Error during extraction: 'NoneType' object has no attribute 'chat'
Error during extraction: 'NoneType' object has no attribute 'chat'
Error during extraction: 'NoneType' object has no attribute 'chat'
Error during extraction: 'NoneType' object has no attribute 'chat'

Results:
'Amazing product! Best purchase...' → None
'Terrible quality. Broke immedi...' → None
'It's fine. Nothing special....' → None
'Great value for money!...' → None
'Disappointed with this purchas...' → None</code></pre>
</div>
</div>
</section>
<section id="converting-to-pandas-dataframe" class="level3">
<h3 class="anchored" data-anchor-id="converting-to-pandas-dataframe">4.4 Converting to pandas DataFrame</h3>
<p>Now the payoff—converting extracted features to a clean DataFrame ready for ML:</p>
<div id="687670f5" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulated extraction results (in practice, these come from API calls)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>extraction_results <span class="op">=</span> [</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"title"</span>: <span class="st">"Senior Data Scientist"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"category"</span>: <span class="st">"Engineering"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"experience_level"</span>: <span class="st">"Senior"</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"remote_policy"</span>: <span class="st">"Remote"</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"key_skills"</span>: [<span class="st">"Python"</span>, <span class="st">"SQL"</span>, <span class="st">"ML"</span>]</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"title"</span>: <span class="st">"Marketing Manager"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"category"</span>: <span class="st">"Marketing"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"experience_level"</span>: <span class="st">"Mid"</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"remote_policy"</span>: <span class="st">"Hybrid"</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"key_skills"</span>: [<span class="st">"SEO"</span>, <span class="st">"Analytics"</span>, <span class="st">"Content"</span>]</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"title"</span>: <span class="st">"Sales Representative"</span>,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"category"</span>: <span class="st">"Sales"</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"experience_level"</span>: <span class="st">"Entry"</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"remote_policy"</span>: <span class="st">"Onsite"</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"key_skills"</span>: [<span class="st">"Communication"</span>, <span class="st">"CRM"</span>]</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(extraction_results)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle the list field (key_skills)</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'num_skills'</span>] <span class="op">=</span> df[<span class="st">'key_skills'</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'skills_str'</span>] <span class="op">=</span> df[<span class="st">'key_skills'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">', '</span>.join(x))</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>df.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">category</th>
<th data-quarto-table-cell-role="th">experience_level</th>
<th data-quarto-table-cell-role="th">remote_policy</th>
<th data-quarto-table-cell-role="th">key_skills</th>
<th data-quarto-table-cell-role="th">num_skills</th>
<th data-quarto-table-cell-role="th">skills_str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Senior Data Scientist</td>
<td>Engineering</td>
<td>Senior</td>
<td>Remote</td>
<td>[Python, SQL, ML]</td>
<td>3</td>
<td>Python, SQL, ML</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Marketing Manager</td>
<td>Marketing</td>
<td>Mid</td>
<td>Hybrid</td>
<td>[SEO, Analytics, Content]</td>
<td>3</td>
<td>SEO, Analytics, Content</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Sales Representative</td>
<td>Sales</td>
<td>Entry</td>
<td>Onsite</td>
<td>[Communication, CRM]</td>
<td>2</td>
<td>Communication, CRM</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now we have a clean DataFrame! The categorical variables (category, experience_level, remote_policy) are ready for encoding. The skills are processed. This data is ready to be fed into machine learning models.</p>
<hr>
</section>
</section>
<section id="integration-with-ml-pipelines" class="level2">
<h2 class="anchored" data-anchor-id="integration-with-ml-pipelines">5. Integration with ML Pipelines</h2>
<section id="the-complete-pipeline-text-features-model" class="level3">
<h3 class="anchored" data-anchor-id="the-complete-pipeline-text-features-model">5.1 The Complete Pipeline: Text → Features → Model</h3>
<p>Let’s build a complete example: extract features from reviews, then predict review helpfulness:</p>
<div id="f155c12a" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulated dataset: product reviews with helpfulness labels</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>reviews_data <span class="op">=</span> {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'review_text'</span>: [</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Amazing product! The quality is outstanding. Highly recommend."</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Total waste of money. Broke after one use."</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"It's okay. Does the job but nothing special."</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Best purchase I've made! Love everything about it."</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Disappointed. Expected better quality for the price."</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Works as described. No complaints."</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Fantastic! Exceeded my expectations in every way."</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Not worth it. Too expensive for what you get."</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Pretty good. Would buy again."</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Terrible product. Avoid at all costs."</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'helpful_votes'</span>: [<span class="dv">45</span>, <span class="dv">32</span>, <span class="dv">8</span>, <span class="dv">51</span>, <span class="dv">28</span>, <span class="dv">12</span>, <span class="dv">48</span>, <span class="dv">25</span>, <span class="dv">15</span>, <span class="dv">38</span>]  <span class="co"># Number of helpful votes</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>df_reviews <span class="op">=</span> pd.DataFrame(reviews_data)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create binary target: helpful (&gt;20 votes) or not helpful (≤20 votes)</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>df_reviews[<span class="st">'is_helpful'</span>] <span class="op">=</span> (df_reviews[<span class="st">'helpful_votes'</span>] <span class="op">&gt;</span> <span class="dv">20</span>).astype(<span class="bu">int</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Dataset:"</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_reviews[[<span class="st">'review_text'</span>, <span class="st">'helpful_votes'</span>, <span class="st">'is_helpful'</span>]].head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset:
                                         review_text  helpful_votes  \
0  Amazing product! The quality is outstanding. H...             45   
1         Total waste of money. Broke after one use.             32   
2       It's okay. Does the job but nothing special.              8   
3  Best purchase I've made! Love everything about...             51   
4  Disappointed. Expected better quality for the ...             28   

   is_helpful  
0           1  
1           1  
2           0  
3           1  
4           1  </code></pre>
</div>
</div>
<p>Now let’s extract features using our LLM:</p>
<div id="eafdb6ab" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_review_features_for_ml(review_text):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract features specifically useful for predicting helpfulness</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> client <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return default values if no API key</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment"</span>: <span class="st">"neutral"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"is_detailed"</span>: <span class="va">False</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions_price_value"</span>: <span class="va">False</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"has_comparison"</span>: <span class="va">False</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""Analyze this product review and extract features.</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="ss">Respond with valid JSON:</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="ss">    "sentiment": "positive/negative/neutral",</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    "is_detailed": true/false,</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="ss">    "mentions_specific_features": true/false,</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    "mentions_price_value": true/false,</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="ss">    "has_comparison": true/false</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: </span><span class="sc">{</span>review_text<span class="sc">}</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="ss">JSON:"""</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="st">"gpt-3.5-turbo"</span>,</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="dv">150</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        result_text <span class="op">=</span> response.choices[<span class="dv">0</span>].message.content.strip()</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        result_text <span class="op">=</span> result_text.replace(<span class="st">'```json'</span>, <span class="st">''</span>).replace(<span class="st">'```'</span>, <span class="st">''</span>).strip()</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> json.loads(result_text)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> features</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return default values if extraction fails</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment"</span>: <span class="st">"neutral"</span>,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"is_detailed"</span>: <span class="va">False</span>,</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mentions_price_value"</span>: <span class="va">False</span>,</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"has_comparison"</span>: <span class="va">False</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract features for all reviews</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: In practice, this would make API calls</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="co"># For this example, we'll simulate the results</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>llm_features <span class="op">=</span> [</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"positive"</span>, <span class="st">"is_detailed"</span>: <span class="va">True</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">True</span>,</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"negative"</span>, <span class="st">"is_detailed"</span>: <span class="va">False</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"neutral"</span>, <span class="st">"is_detailed"</span>: <span class="va">False</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"positive"</span>, <span class="st">"is_detailed"</span>: <span class="va">True</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">True</span>,</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"negative"</span>, <span class="st">"is_detailed"</span>: <span class="va">True</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">True</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"neutral"</span>, <span class="st">"is_detailed"</span>: <span class="va">False</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"positive"</span>, <span class="st">"is_detailed"</span>: <span class="va">True</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">True</span>,</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"negative"</span>, <span class="st">"is_detailed"</span>: <span class="va">True</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">True</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"positive"</span>, <span class="st">"is_detailed"</span>: <span class="va">False</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"sentiment"</span>: <span class="st">"negative"</span>, <span class="st">"is_detailed"</span>: <span class="va">False</span>, <span class="st">"mentions_specific_features"</span>: <span class="va">False</span>,</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>     <span class="st">"mentions_price_value"</span>: <span class="va">False</span>, <span class="st">"has_comparison"</span>: <span class="va">False</span>},</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Add LLM features to DataFrame</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>df_features <span class="op">=</span> pd.DataFrame(llm_features)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>df_reviews <span class="op">=</span> pd.concat([df_reviews, df_features], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>df_reviews.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">review_text</th>
<th data-quarto-table-cell-role="th">helpful_votes</th>
<th data-quarto-table-cell-role="th">is_helpful</th>
<th data-quarto-table-cell-role="th">sentiment</th>
<th data-quarto-table-cell-role="th">is_detailed</th>
<th data-quarto-table-cell-role="th">mentions_specific_features</th>
<th data-quarto-table-cell-role="th">mentions_price_value</th>
<th data-quarto-table-cell-role="th">has_comparison</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Amazing product! The quality is outstanding. H...</td>
<td>45</td>
<td>1</td>
<td>positive</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Total waste of money. Broke after one use.</td>
<td>32</td>
<td>1</td>
<td>negative</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>It's okay. Does the job but nothing special.</td>
<td>8</td>
<td>0</td>
<td>neutral</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Best purchase I've made! Love everything about...</td>
<td>51</td>
<td>1</td>
<td>positive</td>
<td>True</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Disappointed. Expected better quality for the ...</td>
<td>28</td>
<td>1</td>
<td>negative</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="encoding-and-training" class="level3">
<h3 class="anchored" data-anchor-id="encoding-and-training">5.2 Encoding and Training</h3>
<p>Now we have LLM-extracted features. Let’s train a model:</p>
<div id="7d04d436" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode sentiment</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>le <span class="op">=</span> LabelEncoder()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>df_reviews[<span class="st">'sentiment_encoded'</span>] <span class="op">=</span> le.fit_transform(df_reviews[<span class="st">'sentiment'</span>])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Select features for ML model</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>feature_columns <span class="op">=</span> [</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sentiment_encoded'</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_detailed'</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mentions_specific_features'</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mentions_price_value'</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'has_comparison'</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df_reviews[feature_columns]</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df_reviews[<span class="st">'is_helpful'</span>]</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Train-test split</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    X, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Train a classifier</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>clf.fit(X_train, y_train)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Model Performance:"</span>)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred))</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature importance</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'feature'</span>: feature_columns,</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'importance'</span>: clf.feature_importances_</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature Importance:"</span>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(feature_importance)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Model Performance:
              precision    recall  f1-score   support

           0       1.00      0.50      0.67         2
           1       0.50      1.00      0.67         1

    accuracy                           0.67         3
   macro avg       0.75      0.75      0.67         3
weighted avg       0.83      0.67      0.67         3


Feature Importance:
                      feature  importance
0           sentiment_encoded    0.589149
1                 is_detailed    0.295655
2  mentions_specific_features    0.090456
3        mentions_price_value    0.024740
4              has_comparison    0.000000</code></pre>
</div>
</div>
<p>See what we did? We used LLM to extract features from text, encoded them properly, and trained a traditional ML model. The LLM extracted semantic information (sentiment, detail level, specific mentions) that would be hard to capture with simple word counts or regex patterns.</p>
</section>
<section id="avoiding-data-leakage-with-llm-features" class="level3">
<h3 class="anchored" data-anchor-id="avoiding-data-leakage-with-llm-features">5.3 Avoiding Data Leakage with LLM Features</h3>
<p>Important consideration: when do you extract features?</p>
<div id="011b97ea" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG WAY - Data leakage!</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't do this: extracting features from full dataset before split</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The LLM might learn patterns from test set during extraction</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT WAY - Extract after split</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># But wait... LLMs don't "learn" from your prompts in real-time</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># So technically, this isn't data leakage in the traditional sense</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># However, best practice:</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Split your data first</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Develop/test prompts ONLY on training data</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Once prompt is finalized, apply to train and test separately</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Never iterate on prompts while looking at test set results</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The principle: don’t use test set information to develop your extraction prompts, just like you wouldn’t use test set to select model hyperparameters.</p>
</section>
<section id="comparing-with-and-without-llm-features" class="level3">
<h3 class="anchored" data-anchor-id="comparing-with-and-without-llm-features">5.4 Comparing With and Without LLM Features</h3>
<p>Let’s see if LLM features actually help:</p>
<div id="6e1c241d" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline: Just simple features (no LLM)</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df_reviews[<span class="st">'review_length'</span>] <span class="op">=</span> df_reviews[<span class="st">'review_text'</span>].<span class="bu">apply</span>(<span class="bu">len</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>df_reviews[<span class="st">'word_count'</span>] <span class="op">=</span> df_reviews[<span class="st">'review_text'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(x.split()))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>df_reviews[<span class="st">'exclamation_count'</span>] <span class="op">=</span> df_reviews[<span class="st">'review_text'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.count(<span class="st">'!'</span>))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: Without LLM features</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>X_baseline <span class="op">=</span> df_reviews[[<span class="st">'review_length'</span>, <span class="st">'word_count'</span>, <span class="st">'exclamation_count'</span>]]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>X_train_base, X_test_base, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    X_baseline, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>clf_baseline <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>clf_baseline.fit(X_train_base, y_train)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>baseline_score <span class="op">=</span> clf_baseline.score(X_test_base, y_test)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: With LLM features</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>X_llm <span class="op">=</span> df_reviews[[<span class="st">'review_length'</span>, <span class="st">'word_count'</span>, <span class="st">'exclamation_count'</span>] <span class="op">+</span> feature_columns]</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>X_train_llm, X_test_llm, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    X_llm, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>clf_llm <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>clf_llm.fit(X_train_llm, y_train)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>llm_score <span class="op">=</span> clf_llm.score(X_test_llm, y_test)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Baseline model (no LLM) accuracy: </span><span class="sc">{</span>baseline_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"With LLM features accuracy: </span><span class="sc">{</span>llm_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Improvement: </span><span class="sc">{</span>llm_score <span class="op">-</span> baseline_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Baseline model (no LLM) accuracy: 0.000
With LLM features accuracy: 0.333
Improvement: 0.333</code></pre>
</div>
</div>
<p>This comparison tells you whether the LLM extraction was worth the cost. Sometimes it helps significantly. Sometimes simple features work just as well. Always compare!</p>
<hr>
</section>
</section>
<section id="cost-analysis-and-provider-comparison" class="level2">
<h2 class="anchored" data-anchor-id="cost-analysis-and-provider-comparison">6. Cost Analysis and Provider Comparison</h2>
<section id="understanding-token-based-pricing" class="level3">
<h3 class="anchored" data-anchor-id="understanding-token-based-pricing">6.1 Understanding Token-Based Pricing</h3>
<p>LLM APIs charge per token. Understanding costs is crucial:</p>
<div id="5d0a858c" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_tokens(text):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Rough estimate: 1 token ≈ 0.75 words</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Or approximately: 1 token ≈ 4 characters</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 1: Based on words</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    word_estimate <span class="op">=</span> <span class="bu">len</span>(text.split()) <span class="op">*</span> <span class="fl">1.3</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 2: Based on characters</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    char_estimate <span class="op">=</span> <span class="bu">len</span>(text) <span class="op">/</span> <span class="dv">4</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average the two methods</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">int</span>((word_estimate <span class="op">+</span> char_estimate) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Example texts</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>texts <span class="op">=</span> [</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Short review."</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This is a medium-length review with several sentences about the product."</span>,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""This is a long, detailed review that goes into great depth about</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="st">    various aspects of the product including quality, price, features,</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="st">    customer service, shipping speed, packaging, and overall value for money.</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="st">    I would definitely recommend this to anyone considering a purchase."""</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> text <span class="kw">in</span> texts:</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    estimated <span class="op">=</span> estimate_tokens(text)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Text length: </span><span class="sc">{</span><span class="bu">len</span>(text)<span class="sc">}</span><span class="ss"> chars, ~</span><span class="sc">{</span>estimated<span class="sc">}</span><span class="ss"> tokens"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Text length: 13 chars, ~2 tokens
Text length: 72 chars, ~16 tokens
Text length: 285 chars, ~62 tokens</code></pre>
</div>
</div>
</section>
<section id="calculating-extraction-costs" class="level3">
<h3 class="anchored" data-anchor-id="calculating-extraction-costs">6.2 Calculating Extraction Costs</h3>
<p>Let’s calculate real costs for a dataset:</p>
<div id="8831f313" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_extraction_cost(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    num_texts,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    avg_text_length,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    prompt_tokens,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    response_tokens,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">'gpt-3.5-turbo'</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate total cost for extracting features from a dataset</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Pricing (as of 2024):</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - GPT-3.5-turbo: $0.0005 per 1K tokens (input and output)</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - GPT-4: $0.03 per 1K input tokens, $0.06 per 1K output tokens</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - Claude Sonnet: $0.003 per 1K input tokens, $0.015 per 1K output tokens</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate tokens per extraction</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    text_tokens <span class="op">=</span> avg_text_length <span class="op">/</span> <span class="dv">4</span>  <span class="co"># Rough estimate</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    total_input_tokens <span class="op">=</span> (prompt_tokens <span class="op">+</span> text_tokens) <span class="op">*</span> num_texts</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    total_output_tokens <span class="op">=</span> response_tokens <span class="op">*</span> num_texts</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pricing</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model <span class="op">==</span> <span class="st">'gpt-3.5-turbo'</span>:</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        cost_per_1k_input <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        cost_per_1k_output <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model <span class="op">==</span> <span class="st">'gpt-4'</span>:</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>        cost_per_1k_input <span class="op">=</span> <span class="fl">0.03</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        cost_per_1k_output <span class="op">=</span> <span class="fl">0.06</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model <span class="op">==</span> <span class="st">'claude-sonnet'</span>:</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        cost_per_1k_input <span class="op">=</span> <span class="fl">0.003</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        cost_per_1k_output <span class="op">=</span> <span class="fl">0.015</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unknown model: </span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    input_cost <span class="op">=</span> (total_input_tokens <span class="op">/</span> <span class="dv">1000</span>) <span class="op">*</span> cost_per_1k_input</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    output_cost <span class="op">=</span> (total_output_tokens <span class="op">/</span> <span class="dv">1000</span>) <span class="op">*</span> cost_per_1k_output</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    total_cost <span class="op">=</span> input_cost <span class="op">+</span> output_cost</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_input_tokens'</span>: <span class="bu">int</span>(total_input_tokens),</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_output_tokens'</span>: <span class="bu">int</span>(total_output_tokens),</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'input_cost'</span>: input_cost,</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'output_cost'</span>: output_cost,</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_cost'</span>: total_cost</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Extract sentiment from 10,000 product reviews</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>num_reviews <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>avg_review_length <span class="op">=</span> <span class="dv">200</span>  <span class="co"># characters</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>prompt_tokens <span class="op">=</span> <span class="dv">50</span>  <span class="co"># Our prompt</span></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>response_tokens <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Just "positive"/"negative"/"neutral"</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cost comparison for 10,000 reviews:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> [<span class="st">'gpt-3.5-turbo'</span>, <span class="st">'gpt-4'</span>, <span class="st">'claude-sonnet'</span>]:</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>    cost_info <span class="op">=</span> calculate_extraction_cost(</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>        num_reviews, avg_review_length, prompt_tokens, response_tokens, model</span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total tokens: </span><span class="sc">{</span>cost_info[<span class="st">'total_input_tokens'</span>] <span class="op">+</span> cost_info[<span class="st">'total_output_tokens'</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total cost: $</span><span class="sc">{</span>cost_info[<span class="st">'total_cost'</span>]<span class="sc">:.2f}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cost comparison for 10,000 reviews:

gpt-3.5-turbo:
  Total tokens: 1,050,000
  Total cost: $0.53

gpt-4:
  Total tokens: 1,050,000
  Total cost: $33.00

claude-sonnet:
  Total tokens: 1,050,000
  Total cost: $3.75
</code></pre>
</div>
</div>
<p>This shows the dramatic cost difference between models. For simple extraction, GPT-3.5 is often sufficient and much cheaper.</p>
</section>
<section id="when-to-use-which-model" class="level3">
<h3 class="anchored" data-anchor-id="when-to-use-which-model">6.3 When to Use Which Model</h3>
<p>Decision framework:</p>
<div id="fb6d5cce" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> recommend_model(task_complexity, dataset_size, budget):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Recommend which LLM to use based on requirements</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">        task_complexity: 'simple', 'moderate', 'complex'</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">        dataset_size: number of texts to process</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">        budget: maximum budget in dollars</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Recommended model and reasoning</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate costs (simplified)</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    gpt35_cost_per_item <span class="op">=</span> <span class="fl">0.0001</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    gpt4_cost_per_item <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    gpt35_total <span class="op">=</span> gpt35_cost_per_item <span class="op">*</span> dataset_size</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    gpt4_total <span class="op">=</span> gpt4_cost_per_item <span class="op">*</span> dataset_size</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    recommendations <span class="op">=</span> []</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> task_complexity <span class="op">==</span> <span class="st">'simple'</span>:</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        recommendations.append({</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: <span class="st">'gpt-3.5-turbo'</span>,</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reasoning'</span>: <span class="st">'Simple extraction tasks work well with GPT-3.5'</span>,</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">'estimated_cost'</span>: gpt35_total</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> task_complexity <span class="op">==</span> <span class="st">'moderate'</span>:</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gpt35_total <span class="op">&lt;=</span> budget:</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>            recommendations.append({</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'model'</span>: <span class="st">'gpt-3.5-turbo (try first)'</span>,</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">'reasoning'</span>: <span class="st">'Start with GPT-3.5, upgrade if quality insufficient'</span>,</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'estimated_cost'</span>: gpt35_total</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gpt4_total <span class="op">&lt;=</span> budget:</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>            recommendations.append({</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">'model'</span>: <span class="st">'gpt-4 (if GPT-3.5 fails)'</span>,</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'reasoning'</span>: <span class="st">'Better accuracy but 10x cost'</span>,</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">'estimated_cost'</span>: gpt4_total</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># complex</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gpt4_total <span class="op">&lt;=</span> budget:</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>            recommendations.append({</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">'model'</span>: <span class="st">'gpt-4'</span>,</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">'reasoning'</span>: <span class="st">'Complex tasks need GPT-4 reasoning'</span>,</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">'estimated_cost'</span>: gpt4_total</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>            recommendations.append({</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">'model'</span>: <span class="st">'Consider alternatives'</span>,</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">'reasoning'</span>: <span class="st">'Budget insufficient for GPT-4 at this scale. Consider: sampling, fine-tuning smaller model, or traditional NLP'</span>,</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'estimated_cost'</span>: <span class="va">None</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recommendations</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Examples</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>scenarios <span class="op">=</span> [</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'simple'</span>, <span class="dv">10000</span>, <span class="dv">10</span>),</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'moderate'</span>, <span class="dv">5000</span>, <span class="dv">5</span>),</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'complex'</span>, <span class="dv">1000</span>, <span class="dv">50</span>),</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> complexity, size, budget <span class="kw">in</span> scenarios:</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Scenario: </span><span class="sc">{</span>complexity<span class="sc">}</span><span class="ss"> task, </span><span class="sc">{</span>size<span class="sc">:,}</span><span class="ss"> items, $</span><span class="sc">{</span>budget<span class="sc">}</span><span class="ss"> budget"</span>)</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    recs <span class="op">=</span> recommend_model(complexity, size, budget)</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> rec <span class="kw">in</span> recs:</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  → </span><span class="sc">{</span>rec[<span class="st">'model'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>rec[<span class="st">'reasoning'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rec[<span class="st">'estimated_cost'</span>]:</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    Estimated cost: $</span><span class="sc">{</span>rec[<span class="st">'estimated_cost'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Scenario: simple task, 10,000 items, $10 budget
  → gpt-3.5-turbo: Simple extraction tasks work well with GPT-3.5
    Estimated cost: $1.00

Scenario: moderate task, 5,000 items, $5 budget
  → gpt-3.5-turbo (try first): Start with GPT-3.5, upgrade if quality insufficient
    Estimated cost: $0.50
  → gpt-4 (if GPT-3.5 fails): Better accuracy but 10x cost
    Estimated cost: $5.00

Scenario: complex task, 1,000 items, $50 budget
  → gpt-4: Complex tasks need GPT-4 reasoning
    Estimated cost: $1.00</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Cost Optimization Strategies:</strong> 1. <strong>Start cheap:</strong> Try GPT-3.5 first, upgrade only if needed 2. <strong>Sample first:</strong> Test on 100 examples before processing 10,000 3. <strong>Shorten prompts:</strong> Every token counts—be concise 4. <strong>Cache results:</strong> Don’t reprocess the same text twice 5. <strong>Consider batching:</strong> Some providers offer batch APIs at lower cost</p>
</div>
</div>
</section>
<section id="roi-analysis-llm-vs.-alternatives" class="level3">
<h3 class="anchored" data-anchor-id="roi-analysis-llm-vs.-alternatives">6.4 ROI Analysis: LLM vs.&nbsp;Alternatives</h3>
<p>Is LLM extraction worth it? Compare alternatives:</p>
<div id="051d1c09" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenario: Classify 10,000 customer support tickets</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>alternatives <span class="op">=</span> {</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Manual labeling'</span>: {</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cost'</span>: <span class="fl">0.50</span> <span class="op">*</span> <span class="dv">10000</span>,  <span class="co"># $0.50 per ticket</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_hours'</span>: <span class="dv">333</span>,  <span class="co"># 2 mins per ticket</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: <span class="fl">0.95</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scalability'</span>: <span class="st">'Poor'</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Traditional ML (train from scratch)'</span>: {</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cost'</span>: <span class="dv">2000</span>,  <span class="co"># Data labeling for training set</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_hours'</span>: <span class="dv">40</span>,  <span class="co"># Development time</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: <span class="fl">0.85</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scalability'</span>: <span class="st">'Excellent (after training)'</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LLM extraction (GPT-3.5)'</span>: {</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cost'</span>: <span class="fl">1.0</span> <span class="op">*</span> <span class="dv">10000</span> <span class="op">*</span> <span class="fl">0.0001</span>,  <span class="co"># $1.00</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_hours'</span>: <span class="dv">1</span>,  <span class="co"># Just API calls</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: <span class="fl">0.90</span>,</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scalability'</span>: <span class="st">'Excellent'</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LLM extraction (GPT-4)'</span>: {</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cost'</span>: <span class="fl">10.0</span> <span class="op">*</span> <span class="dv">10000</span> <span class="op">*</span> <span class="fl">0.0001</span>,  <span class="co"># $10.00</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'time_hours'</span>: <span class="dv">1</span>,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: <span class="fl">0.93</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scalability'</span>: <span class="st">'Excellent'</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> pd.DataFrame(alternatives).T</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>comparison.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">cost</th>
<th data-quarto-table-cell-role="th">time_hours</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">scalability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Manual labeling</th>
<td>5000.0</td>
<td>333</td>
<td>0.95</td>
<td>Poor</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Traditional ML (train from scratch)</th>
<td>2000</td>
<td>40</td>
<td>0.85</td>
<td>Excellent (after training)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">LLM extraction (GPT-3.5)</th>
<td>1.0</td>
<td>1</td>
<td>0.9</td>
<td>Excellent</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">LLM extraction (GPT-4)</th>
<td>10.0</td>
<td>1</td>
<td>0.93</td>
<td>Excellent</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For this scenario, LLM extraction with GPT-3.5 is clearly the winner: cheap, fast, accurate enough, and scalable. But the best choice depends on your specific constraints.</p>
<hr>
</section>
</section>
<section id="quality-control-and-validation" class="level2">
<h2 class="anchored" data-anchor-id="quality-control-and-validation">7. Quality Control and Validation</h2>
<section id="measuring-extraction-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="measuring-extraction-accuracy">7.1 Measuring Extraction Accuracy</h3>
<p>How do you know if your LLM extraction is working well?</p>
<div id="ed0d7f76" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_extraction_accuracy(extracted, ground_truth):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare LLM extractions to ground truth labels</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">        extracted: List of LLM-extracted labels</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">        ground_truth: List of correct labels</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Accuracy metrics</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    correct <span class="op">=</span> <span class="bu">sum</span>(e <span class="op">==</span> g <span class="cf">for</span> e, g <span class="kw">in</span> <span class="bu">zip</span>(extracted, ground_truth))</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="bu">len</span>(ground_truth)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> correct <span class="op">/</span> total</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Breakdown by category</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    category_stats <span class="op">=</span> defaultdict(<span class="kw">lambda</span>: {<span class="st">'correct'</span>: <span class="dv">0</span>, <span class="st">'total'</span>: <span class="dv">0</span>})</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ext, truth <span class="kw">in</span> <span class="bu">zip</span>(extracted, ground_truth):</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>        category_stats[truth][<span class="st">'total'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ext <span class="op">==</span> truth:</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>            category_stats[truth][<span class="st">'correct'</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'overall_accuracy'</span>: accuracy,</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'correct'</span>: correct,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total'</span>: total,</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'by_category'</span>: <span class="bu">dict</span>(category_stats)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Sentiment extraction validation</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>ground_truth_sentiments <span class="op">=</span> [<span class="st">'positive'</span>, <span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'negative'</span>]</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>llm_extracted_sentiments <span class="op">=</span> [<span class="st">'positive'</span>, <span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'negative'</span>]</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> calculate_extraction_accuracy(llm_extracted_sentiments, ground_truth_sentiments)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall accuracy: </span><span class="sc">{</span>accuracy[<span class="st">'overall_accuracy'</span>]<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Correct: </span><span class="sc">{</span>accuracy[<span class="st">'correct'</span>]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>accuracy[<span class="st">'total'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Overall accuracy: 100.00%
Correct: 5/5</code></pre>
</div>
</div>
</section>
<section id="spot-checking-and-manual-review" class="level3">
<h3 class="anchored" data-anchor-id="spot-checking-and-manual-review">7.2 Spot-Checking and Manual Review</h3>
<p>You can’t manually check everything, but strategic sampling helps:</p>
<div id="69cc7daa" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spot_check_extractions(texts, extractions, n_samples<span class="op">=</span><span class="dv">20</span>, random_state<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Sample extractions for manual review</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows random samples + edge cases for human verification</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    np.random.seed(random_state)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random sample</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> np.random.choice(<span class="bu">len</span>(texts), <span class="bu">min</span>(n_samples, <span class="bu">len</span>(texts)), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Random sample for manual review:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(indices, <span class="dv">1</span>):</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">. Text: </span><span class="sc">{</span>texts[idx][:<span class="dv">80</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Extraction: </span><span class="sc">{</span>extractions[idx]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Correct? (Y/N): ___"</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> indices</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>sample_reviews <span class="op">=</span> [</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This product is amazing! Love it."</span>,</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Terrible. Waste of money."</span>,</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"It's okay, I guess."</span>,</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Best purchase ever made!"</span>,</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Not great, not terrible."</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>sample_sentiments <span class="op">=</span> [<span class="st">'positive'</span>, <span class="st">'negative'</span>, <span class="st">'neutral'</span>, <span class="st">'positive'</span>, <span class="st">'neutral'</span>]</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>spot_check_extractions(sample_reviews, sample_sentiments, n_samples<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random sample for manual review:

1. Text: Terrible. Waste of money....
   Extraction: negative
   Correct? (Y/N): ___

2. Text: Not great, not terrible....
   Extraction: neutral
   Correct? (Y/N): ___

3. Text: It's okay, I guess....
   Extraction: neutral
   Correct? (Y/N): ___
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>array([1, 4, 2])</code></pre>
</div>
</div>
</section>
<section id="identifying-systematic-errors" class="level3">
<h3 class="anchored" data-anchor-id="identifying-systematic-errors">7.3 Identifying Systematic Errors</h3>
<p>Look for patterns in failures:</p>
<div id="a45d53e7" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_errors(texts, extracted, ground_truth):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Find patterns in extraction errors</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    errors <span class="op">=</span> []</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> text, ext, truth <span class="kw">in</span> <span class="bu">zip</span>(texts, extracted, ground_truth):</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ext <span class="op">!=</span> truth:</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>            errors.append({</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">'text'</span>: text,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'extracted'</span>: ext,</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ground_truth'</span>: truth,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'text_length'</span>: <span class="bu">len</span>(text),</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'word_count'</span>: <span class="bu">len</span>(text.split())</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> errors:</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No errors found!"</span>)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    error_df <span class="op">=</span> pd.DataFrame(errors)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total errors: </span><span class="sc">{</span><span class="bu">len</span>(errors)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(texts)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(errors)<span class="op">/</span><span class="bu">len</span>(texts)<span class="sc">:.1%}</span><span class="ss">)</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyze error patterns</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Errors by true category:"</span>)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(error_df[<span class="st">'ground_truth'</span>].value_counts())</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Average length of texts with errors:"</span>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Characters: </span><span class="sc">{</span>error_df[<span class="st">'text_length'</span>]<span class="sc">.</span>mean()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Words: </span><span class="sc">{</span>error_df[<span class="st">'word_count'</span>]<span class="sc">.</span>mean()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample errors:"</span>)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> error_df.head(<span class="dv">3</span>).iterrows():</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Text: </span><span class="sc">{</span>row[<span class="st">'text'</span>][:<span class="dv">60</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Extracted: </span><span class="sc">{</span>row[<span class="st">'extracted'</span>]<span class="sc">}</span><span class="ss">, True: </span><span class="sc">{</span>row[<span class="st">'ground_truth'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> error_df</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Example with some errors</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>texts_with_errors <span class="op">=</span> [</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Love this product!"</span>,</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"It's not bad."</span>,  <span class="co"># Tricky: double negative</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Terrible quality."</span>,</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I wouldn't say it's good."</span>,  <span class="co"># Tricky: negation</span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amazing!"</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>extracted_with_errors <span class="op">=</span> [<span class="st">'positive'</span>, <span class="st">'negative'</span>, <span class="st">'negative'</span>, <span class="st">'negative'</span>, <span class="st">'positive'</span>]</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>ground_truth_with_errors <span class="op">=</span> [<span class="st">'positive'</span>, <span class="st">'positive'</span>, <span class="st">'negative'</span>, <span class="st">'negative'</span>, <span class="st">'positive'</span>]</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>error_analysis <span class="op">=</span> analyze_errors(texts_with_errors, extracted_with_errors, ground_truth_with_errors)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total errors: 1/5 (20.0%)

Errors by true category:
ground_truth
positive    1
Name: count, dtype: int64

Average length of texts with errors:
  Characters: 13
  Words: 3

Sample errors:
  Text: It's not bad....
  Extracted: negative, True: positive
</code></pre>
</div>
</div>
</section>
<section id="when-extraction-quality-is-good-enough" class="level3">
<h3 class="anchored" data-anchor-id="when-extraction-quality-is-good-enough">7.4 When Extraction Quality Is “Good Enough”</h3>
<p>Perfect extraction isn’t always necessary:</p>
<div id="d13d6f9c" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_quality_sufficient(accuracy, task_requirements):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Determine if extraction quality meets requirements</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">        accuracy: Measured extraction accuracy (0-1)</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">        task_requirements: Dict with requirements</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Boolean and explanation</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    min_accuracy <span class="op">=</span> task_requirements.get(<span class="st">'min_accuracy'</span>, <span class="fl">0.85</span>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    critical_task <span class="op">=</span> task_requirements.get(<span class="st">'critical'</span>, <span class="va">False</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> critical_task:</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># High-stakes tasks need very high accuracy</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        threshold <span class="op">=</span> <span class="bu">max</span>(min_accuracy, <span class="fl">0.95</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        sufficient <span class="op">=</span> accuracy <span class="op">&gt;=</span> threshold</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> <span class="ss">f"Critical task requires ≥</span><span class="sc">{</span>threshold<span class="sc">:.0%}</span><span class="ss"> accuracy. "</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normal tasks can tolerate some errors</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>        threshold <span class="op">=</span> min_accuracy</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        sufficient <span class="op">=</span> accuracy <span class="op">&gt;=</span> threshold</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> <span class="ss">f"Task requires ≥</span><span class="sc">{</span>threshold<span class="sc">:.0%}</span><span class="ss"> accuracy. "</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">+=</span> <span class="ss">f"Current accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.1%}</span><span class="ss">. "</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    msg <span class="op">+=</span> <span class="st">"✓ Sufficient"</span> <span class="cf">if</span> sufficient <span class="cf">else</span> <span class="st">"✗ Insufficient"</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sufficient, msg</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Examples</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>scenarios_quality <span class="op">=</span> [</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">0.92</span>, {<span class="st">'min_accuracy'</span>: <span class="fl">0.85</span>, <span class="st">'critical'</span>: <span class="va">False</span>}),  <span class="co"># Good enough</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">0.92</span>, {<span class="st">'min_accuracy'</span>: <span class="fl">0.85</span>, <span class="st">'critical'</span>: <span class="va">True</span>}),   <span class="co"># Not good enough (critical)</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">0.78</span>, {<span class="st">'min_accuracy'</span>: <span class="fl">0.85</span>, <span class="st">'critical'</span>: <span class="va">False</span>}),  <span class="co"># Not good enough</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> acc, reqs <span class="kw">in</span> scenarios_quality:</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    sufficient, message <span class="op">=</span> is_quality_sufficient(acc, reqs)</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(message)</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Task requires ≥85% accuracy. Current accuracy: 92.0%. ✓ Sufficient

Critical task requires ≥95% accuracy. Current accuracy: 92.0%. ✗ Insufficient

Task requires ≥85% accuracy. Current accuracy: 78.0%. ✗ Insufficient
</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Quality Thresholds by Task Type:</strong> - <strong>Medical/Legal:</strong> 95%+ accuracy required (often manual review needed) - <strong>Financial:</strong> 90-95% accuracy - <strong>Marketing/Content:</strong> 80-85% accuracy often sufficient - <strong>Exploratory analysis:</strong> 70-80% may be acceptable</p>
<p>Remember: LLM features are inputs to ML models. Small extraction errors might not significantly hurt final model performance.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="when-to-use-llms-vs.-traditional-nlp" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-llms-vs.-traditional-nlp">8. When to Use LLMs vs.&nbsp;Traditional NLP</h2>
<section id="decision-framework" class="level3">
<h3 class="anchored" data-anchor-id="decision-framework">8.1 Decision Framework</h3>
<p>Not every text problem needs an LLM. Here’s how to decide:</p>
<div id="17c46b2b" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> should_use_llm(task_description):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Decision tree: LLM vs. traditional NLP</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns recommendation and reasoning</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple pattern matching tasks</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    simple_patterns <span class="op">=</span> [</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contains keyword'</span>,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'find email addresses'</span>,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'extract phone numbers'</span>,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'detect URLs'</span>,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'count words'</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Traditional ML appropriate</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    traditional_ml_tasks <span class="op">=</span> [</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'you have large labeled dataset'</span>,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'need very fast inference'</span>,</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'extremely cost-sensitive'</span>,</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'offline/no internet'</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LLM appropriate</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    llm_tasks <span class="op">=</span> [</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'understand context'</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'extract categories not seen before'</span>,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'handle nuance'</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'multiple languages'</span>,</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'complex reasoning'</span>,</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'no labeled data available'</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    task_lower <span class="op">=</span> task_description.lower()</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check each category</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(pattern <span class="kw">in</span> task_lower <span class="cf">for</span> pattern <span class="kw">in</span> simple_patterns):</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recommendation'</span>: <span class="st">'Use regex or simple string matching'</span>,</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reasoning'</span>: <span class="st">'Simple pattern matching - no need for expensive LLM'</span>,</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'example_tool'</span>: <span class="st">'re module in Python'</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(indicator <span class="kw">in</span> task_lower <span class="cf">for</span> indicator <span class="kw">in</span> traditional_ml_tasks):</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recommendation'</span>: <span class="st">'Train traditional ML model'</span>,</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reasoning'</span>: <span class="st">'Your constraints favor traditional ML over LLM APIs'</span>,</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'example_tool'</span>: <span class="st">'scikit-learn text classification'</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(indicator <span class="kw">in</span> task_lower <span class="cf">for</span> indicator <span class="kw">in</span> llm_tasks):</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recommendation'</span>: <span class="st">'Use LLM extraction'</span>,</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'reasoning'</span>: <span class="st">'Task requires language understanding that LLMs excel at'</span>,</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">'example_tool'</span>: <span class="st">'GPT-3.5 or GPT-4 via API'</span></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Default: try simple first</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'recommendation'</span>: <span class="st">'Try simple methods first, then LLM if needed'</span>,</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reasoning'</span>: <span class="st">'Always start with simplest solution'</span>,</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">'example_tool'</span>: <span class="st">'Regex → Traditional ML → LLM (in that order)'</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with different tasks</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>tasks <span class="op">=</span> [</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Extract email addresses from text"</span>,</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Determine sentiment of product reviews with nuanced language"</span>,</span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Classify support tickets into categories with 10,000 labeled examples"</span>,</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Extract job requirements that vary significantly across postings"</span>,</span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Count how many times 'refund' appears in complaints"</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Task recommendations:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> task <span class="kw">in</span> tasks:</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    rec <span class="op">=</span> should_use_llm(task)</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Task: </span><span class="sc">{</span>task<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  → </span><span class="sc">{</span>rec[<span class="st">'recommendation'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Reasoning: </span><span class="sc">{</span>rec[<span class="st">'reasoning'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Tool: </span><span class="sc">{</span>rec[<span class="st">'example_tool'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Task recommendations:

Task: Extract email addresses from text
  → Try simple methods first, then LLM if needed
  Reasoning: Always start with simplest solution
  Tool: Regex → Traditional ML → LLM (in that order)

Task: Determine sentiment of product reviews with nuanced language
  → Try simple methods first, then LLM if needed
  Reasoning: Always start with simplest solution
  Tool: Regex → Traditional ML → LLM (in that order)

Task: Classify support tickets into categories with 10,000 labeled examples
  → Try simple methods first, then LLM if needed
  Reasoning: Always start with simplest solution
  Tool: Regex → Traditional ML → LLM (in that order)

Task: Extract job requirements that vary significantly across postings
  → Try simple methods first, then LLM if needed
  Reasoning: Always start with simplest solution
  Tool: Regex → Traditional ML → LLM (in that order)

Task: Count how many times 'refund' appears in complaints
  → Try simple methods first, then LLM if needed
  Reasoning: Always start with simplest solution
  Tool: Regex → Traditional ML → LLM (in that order)
</code></pre>
</div>
</div>
</section>
<section id="simple-regex-vs.-llm-a-comparison" class="level3">
<h3 class="anchored" data-anchor-id="simple-regex-vs.-llm-a-comparison">8.2 Simple Regex vs.&nbsp;LLM: A Comparison</h3>
<p>Let’s see both approaches on the same task:</p>
<div id="7703989d" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Task: Extract product category from reviews</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach 1: Regex/keyword matching</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_category_regex(review_text):</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple keyword matching"""</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    text_lower <span class="op">=</span> review_text.lower()</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'coffee'</span>, <span class="st">'brew'</span>, <span class="st">'espresso'</span>, <span class="st">'caffeine'</span>]):</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Coffee Maker'</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'vacuum'</span>, <span class="st">'clean'</span>, <span class="st">'suction'</span>, <span class="st">'dirt'</span>]):</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Vacuum'</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'headphone'</span>, <span class="st">'audio'</span>, <span class="st">'sound'</span>, <span class="st">'music'</span>]):</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Headphones'</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach 2: LLM extraction</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_category_llm(review_text):</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""LLM-based category extraction"""</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""What product category is this review about?</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="ss">Choose from: Coffee Maker, Vacuum, Headphones, Other</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="ss">Review: </span><span class="sc">{</span>review_text<span class="sc">}</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="ss">Category:"""</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulated LLM response</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In practice, this would call the API</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For now, we'll simulate based on content</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    text_lower <span class="op">=</span> review_text.lower()</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'coffee'</span> <span class="kw">in</span> text_lower <span class="kw">or</span> <span class="st">'brew'</span> <span class="kw">in</span> text_lower:</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Coffee Maker'</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'vacuum'</span> <span class="kw">in</span> text_lower <span class="kw">or</span> <span class="st">'clean'</span> <span class="kw">in</span> text_lower:</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Vacuum'</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'headphone'</span> <span class="kw">in</span> text_lower <span class="kw">or</span> <span class="st">'sound'</span> <span class="kw">in</span> text_lower:</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Headphones'</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Test cases</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>test_reviews <span class="op">=</span> [</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This coffee maker brews excellent coffee."</span>,  <span class="co"># Simple - both work</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Makes great espresso every morning."</span>,  <span class="co"># Simple - both work</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"The audio quality is amazing!"</span>,  <span class="co"># LLM better (understands audio → headphones)</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Keeps my floors spotless."</span>,  <span class="co"># LLM better (spotless → cleaning → vacuum)</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Battery life could be better but the noise cancellation is top-notch."</span>  <span class="co"># LLM much better</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Category extraction comparison:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> review <span class="kw">in</span> test_reviews:</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    regex_cat <span class="op">=</span> extract_category_regex(review)</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>    llm_cat <span class="op">=</span> extract_category_llm(review)</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Review: </span><span class="sc">{</span>review<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Regex: </span><span class="sc">{</span>regex_cat<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  LLM: </span><span class="sc">{</span>llm_cat<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Category extraction comparison:

Review: This coffee maker brews excellent coffee.
  Regex: Coffee Maker
  LLM: Coffee Maker

Review: Makes great espresso every morning.
  Regex: Coffee Maker
  LLM: Other

Review: The audio quality is amazing!
  Regex: Headphones
  LLM: Other

Review: Keeps my floors spotless.
  Regex: Other
  LLM: Other

Review: Battery life could be better but the noise cancellation is top-notch.
  Regex: Other
  LLM: Other
</code></pre>
</div>
</div>
<p>The LLM shines when: - Keywords aren’t explicit (“noise cancellation” → headphones) - Context matters (“spotless” → cleaning → vacuum) - Synonyms and paraphrasing (“audio quality” = sound)</p>
<p>Regex wins when: - Keywords are explicit and consistent - Speed is critical - Cost must be zero</p>
</section>
<section id="cost-benefit-comparison-table" class="level3">
<h3 class="anchored" data-anchor-id="cost-benefit-comparison-table">8.3 Cost-Benefit Comparison Table</h3>
<div id="b9721d7c" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>comparison_data <span class="op">=</span> {</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Approach'</span>: [<span class="st">'Regex/Keywords'</span>, <span class="st">'Traditional ML'</span>, <span class="st">'LLM (GPT-3.5)'</span>, <span class="st">'LLM (GPT-4)'</span>],</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Setup Cost'</span>: [<span class="st">'$0'</span>, <span class="st">'$500-5000'</span>, <span class="st">'$0'</span>, <span class="st">'$0'</span>],</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Per-Item Cost'</span>: [<span class="st">'$0'</span>, <span class="st">'$0'</span>, <span class="st">'$0.0001'</span>, <span class="st">'$0.001'</span>],</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Setup Time'</span>: [<span class="st">'1 hour'</span>, <span class="st">'1-4 weeks'</span>, <span class="st">'1-2 hours'</span>, <span class="st">'1-2 hours'</span>],</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Accuracy (simple)'</span>: [<span class="st">'60-70%'</span>, <span class="st">'85-90%'</span>, <span class="st">'85-90%'</span>, <span class="st">'90-95%'</span>],</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Accuracy (complex)'</span>: [<span class="st">'40-50%'</span>, <span class="st">'75-85%'</span>, <span class="st">'80-90%'</span>, <span class="st">'88-95%'</span>],</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Scalability'</span>: [<span class="st">'Excellent'</span>, <span class="st">'Excellent'</span>, <span class="st">'Good'</span>, <span class="st">'Good'</span>],</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Flexibility'</span>: [<span class="st">'Poor'</span>, <span class="st">'Poor'</span>, <span class="st">'Excellent'</span>, <span class="st">'Excellent'</span>]</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>comparison_df <span class="op">=</span> pd.DataFrame(comparison_data)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>comparison_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Approach</th>
<th data-quarto-table-cell-role="th">Setup Cost</th>
<th data-quarto-table-cell-role="th">Per-Item Cost</th>
<th data-quarto-table-cell-role="th">Setup Time</th>
<th data-quarto-table-cell-role="th">Accuracy (simple)</th>
<th data-quarto-table-cell-role="th">Accuracy (complex)</th>
<th data-quarto-table-cell-role="th">Scalability</th>
<th data-quarto-table-cell-role="th">Flexibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Regex/Keywords</td>
<td>$0</td>
<td>$0</td>
<td>1 hour</td>
<td>60-70%</td>
<td>40-50%</td>
<td>Excellent</td>
<td>Poor</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Traditional ML</td>
<td>$500-5000</td>
<td>$0</td>
<td>1-4 weeks</td>
<td>85-90%</td>
<td>75-85%</td>
<td>Excellent</td>
<td>Poor</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>LLM (GPT-3.5)</td>
<td>$0</td>
<td>$0.0001</td>
<td>1-2 hours</td>
<td>85-90%</td>
<td>80-90%</td>
<td>Good</td>
<td>Excellent</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>LLM (GPT-4)</td>
<td>$0</td>
<td>$0.001</td>
<td>1-2 hours</td>
<td>90-95%</td>
<td>88-95%</td>
<td>Good</td>
<td>Excellent</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="hybrid-approaches" class="level3">
<h3 class="anchored" data-anchor-id="hybrid-approaches">8.4 Hybrid Approaches</h3>
<p>Often, the best solution combines methods:</p>
<div id="a8201dc6" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hybrid_extraction(review_text):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Hybrid approach: Use simple rules when possible, LLM for hard cases</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Try simple keyword matching</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    simple_result <span class="op">=</span> extract_category_regex(review_text)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Check confidence</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the review explicitly mentions category keywords, trust regex</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    text_lower <span class="op">=</span> review_text.lower()</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    explicit_mentions <span class="op">=</span> <span class="bu">sum</span>([</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'coffee'</span>, <span class="st">'brew'</span>, <span class="st">'espresso'</span>]),</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'vacuum'</span>, <span class="st">'suction'</span>]),</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'headphone'</span>, <span class="st">'audio'</span>])</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> explicit_mentions <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> simple_result <span class="op">!=</span> <span class="st">'Other'</span>:</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># High confidence - use regex result</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'category'</span>: simple_result,</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'method'</span>: <span class="st">'regex'</span>,</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cost'</span>: <span class="dv">0</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Low confidence - use LLM</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>        llm_result <span class="op">=</span> extract_category_llm(review_text)</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">'category'</span>: llm_result,</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">'method'</span>: <span class="st">'llm'</span>,</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cost'</span>: <span class="fl">0.0001</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Test hybrid approach</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Hybrid approach results:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> review <span class="kw">in</span> test_reviews[:<span class="dv">3</span>]:</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> hybrid_extraction(review)</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Review: </span><span class="sc">{</span>review<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Category: </span><span class="sc">{</span>result[<span class="st">'category'</span>]<span class="sc">}</span><span class="ss"> (via </span><span class="sc">{</span>result[<span class="st">'method'</span>]<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Cost: $</span><span class="sc">{</span>result[<span class="st">'cost'</span>]<span class="sc">:.6f}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hybrid approach results:

Review: This coffee maker brews excellent coffee.
  Category: Coffee Maker (via regex)
  Cost: $0.000000

Review: Makes great espresso every morning.
  Category: Coffee Maker (via regex)
  Cost: $0.000000

Review: The audio quality is amazing!
  Category: Headphones (via regex)
  Cost: $0.000000
</code></pre>
</div>
</div>
<p>This hybrid approach saves money by using free regex when confidence is high, falling back to LLM only when needed.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Hybrid Strategy Benefits:</strong> - Use regex/keywords for 60-80% of cases (free, fast) - Use LLM for ambiguous 20-40% (accuracy boost where it matters) - Best of both worlds: low cost + high accuracy</p>
</div>
</div>
<hr>
</section>
</section>
<section id="practical-considerations-and-best-practices" class="level2">
<h2 class="anchored" data-anchor-id="practical-considerations-and-best-practices">9. Practical Considerations and Best Practices</h2>
<section id="rate-limiting-and-api-quotas" class="level3">
<h3 class="anchored" data-anchor-id="rate-limiting-and-api-quotas">9.1 Rate Limiting and API Quotas</h3>
<p>APIs have limits. Handle them gracefully:</p>
<div id="935509cf" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_with_rate_limiting(texts, extract_func, requests_per_minute<span class="op">=</span><span class="dv">60</span>):</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract features with rate limiting to avoid API errors</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">        texts: List of texts to process</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">        extract_func: Function that extracts from one text</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">        requests_per_minute: Max API calls per minute</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co">        List of extracted features</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    delay <span class="op">=</span> <span class="dv">60</span> <span class="op">/</span> requests_per_minute  <span class="co"># Seconds between requests</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, text <span class="kw">in</span> <span class="bu">enumerate</span>(texts):</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> extract_func(text)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>        results.append(result)</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Progress update</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(texts)<span class="sc">}</span><span class="ss"> texts..."</span>)</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rate limit (except for last item)</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(texts) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>            time.sleep(delay)</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage (simulated)</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Processing with rate limiting:"</span>)</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rate: 60 requests/minute (1 per second)"</span>)</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"For 100 texts, this will take ~100 seconds</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a><span class="co"># In practice:</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a><span class="co"># results = extract_with_rate_limiting(my_texts, extract_sentiment_robust, requests_per_minute=60)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing with rate limiting:
Rate: 60 requests/minute (1 per second)
For 100 texts, this will take ~100 seconds
</code></pre>
</div>
</div>
</section>
<section id="error-handling-and-retries" class="level3">
<h3 class="anchored" data-anchor-id="error-handling-and-retries">9.2 Error Handling and Retries</h3>
<p>Networks fail. APIs timeout. Handle it:</p>
<div id="4e617b69" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_with_retry(text, extract_func, max_retries<span class="op">=</span><span class="dv">3</span>, backoff<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract with exponential backoff retry logic</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="co">        text: Text to extract from</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">        extract_func: Extraction function</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co">        max_retries: Maximum retry attempts</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co">        backoff: Backoff multiplier (2 = double wait time each retry)</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    wait_time <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Start with 1 second wait</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> extract_func(text)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">==</span> max_retries <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Last attempt failed</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Failed after </span><span class="sc">{</span>max_retries<span class="sc">}</span><span class="ss"> attempts: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Retry with exponential backoff</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Attempt </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> failed, retrying in </span><span class="sc">{</span>wait_time<span class="sc">}</span><span class="ss">s..."</span>)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>                time.sleep(wait_time)</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>                wait_time <span class="op">*=</span> backoff</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Example retry behavior (simulated):"</span>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Attempt 1 fails → wait 1s"</span>)</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Attempt 2 fails → wait 2s"</span>)</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Attempt 3 succeeds → return result"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Example retry behavior (simulated):
Attempt 1 fails → wait 1s
Attempt 2 fails → wait 2s
Attempt 3 succeeds → return result</code></pre>
</div>
</div>
</section>
<section id="caching-results-to-avoid-reprocessing" class="level3">
<h3 class="anchored" data-anchor-id="caching-results-to-avoid-reprocessing">9.3 Caching Results to Avoid Reprocessing</h3>
<p>Never process the same text twice:</p>
<div id="ae3bd6a9" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMCache:</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple cache for LLM extraction results"""</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cache <span class="op">=</span> {}</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get(<span class="va">self</span>, text):</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get cached result if available"""</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use hash of text as key</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="bu">hash</span>(text)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.cache.get(key)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">set</span>(<span class="va">self</span>, text, result):</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Store result in cache"""</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="bu">hash</span>(text)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cache[key] <span class="op">=</span> result</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_with_cache(<span class="va">self</span>, text, extract_func):</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract with caching"""</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check cache first</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>        cached <span class="op">=</span> <span class="va">self</span>.get(text)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cached <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> cached</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Not in cache - extract and store</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> extract_func(text)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">set</span>(text, result)</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage example</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> LLMCache()</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>texts_with_duplicates <span class="op">=</span> [</span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This is great!"</span>,</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This is terrible."</span>,</span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This is great!"</span>,  <span class="co"># Duplicate - will use cache</span></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This is okay."</span>,</span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This is great!"</span>   <span class="co"># Duplicate - will use cache</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Processing with cache:"</span>)</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> text <span class="kw">in</span> texts_with_duplicates:</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In practice, would call API</span></span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>    cached_result <span class="op">=</span> cache.get(text)</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cached_result:</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"'</span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">' → CACHED"</span>)</span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Simulate extraction</span></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="st">"positive"</span>  <span class="co"># Simulated</span></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>        cache.<span class="bu">set</span>(text, result)</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"'</span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">' → EXTRACTED (API call)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing with cache:
'This is great!' → EXTRACTED (API call)
'This is terrible.' → EXTRACTED (API call)
'This is great!' → CACHED
'This is okay.' → EXTRACTED (API call)
'This is great!' → CACHED</code></pre>
</div>
</div>
</section>
<section id="logging-and-monitoring" class="level3">
<h3 class="anchored" data-anchor-id="logging-and-monitoring">9.4 Logging and Monitoring</h3>
<p>Track your extractions for debugging:</p>
<div id="4dadc2af" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up logging</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    level<span class="op">=</span>logging.INFO,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">'</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(levelname)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">'</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_with_logging(text, extract_func):</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract with detailed logging"""</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> datetime.now()</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="ss">f"Starting extraction for text: </span><span class="sc">{</span>text[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> extract_func(text)</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>        duration <span class="op">=</span> (datetime.now() <span class="op">-</span> start_time).total_seconds()</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Extraction successful in </span><span class="sc">{</span>duration<span class="sc">:.2f}</span><span class="ss">s: </span><span class="sc">{</span>result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>        duration <span class="op">=</span> (datetime.now() <span class="op">-</span> start_time).total_seconds()</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Extraction failed after </span><span class="sc">{</span>duration<span class="sc">:.2f}</span><span class="ss">s: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Example</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Extraction with logging:"</span>)</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="co"># result = extract_with_logging("Test review", extract_sentiment_robust)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extraction with logging:</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="real-world-example-complete-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="real-world-example-complete-pipeline">10. Real-World Example: Complete Pipeline</h2>
<p>Let’s put it all together with a complete, realistic example:</p>
<div id="113f0416" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenario: Extract features from customer support tickets</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use those features to predict ticket priority</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample support tickets</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>tickets_data <span class="op">=</span> {</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticket_id'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticket_text'</span>: [</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"My account is locked and I can't access my billing information. This is urgent!"</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"I have a question about your pricing plans. No rush."</span>,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"The app keeps crashing every time I try to upload a file. Very frustrating!"</span>,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Can you explain how the export feature works?"</span>,</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CRITICAL: Production server is down! Need immediate assistance!"</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'actual_priority'</span>: [<span class="st">'high'</span>, <span class="st">'low'</span>, <span class="st">'medium'</span>, <span class="st">'low'</span>, <span class="st">'critical'</span>]  <span class="co"># Ground truth</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>df_tickets <span class="op">=</span> pd.DataFrame(tickets_data)</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Define extraction function</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_ticket_features(ticket_text):</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract features from support ticket</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In real implementation, this would call OpenAI API</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For this example, we'll simulate the extraction</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simulated LLM extraction logic</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    text_lower <span class="op">=</span> ticket_text.lower()</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine urgency</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'critical'</span>, <span class="st">'urgent'</span>, <span class="st">'down'</span>, <span class="st">'broken'</span>]):</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>        urgency <span class="op">=</span> <span class="st">'high'</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'frustrating'</span>, <span class="st">'issue'</span>, <span class="st">'problem'</span>]):</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>        urgency <span class="op">=</span> <span class="st">'medium'</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>        urgency <span class="op">=</span> <span class="st">'low'</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine category</span></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'billing'</span>, <span class="st">'account'</span>, <span class="st">'payment'</span>]):</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>        category <span class="op">=</span> <span class="st">'Billing'</span></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'crash'</span>, <span class="st">'bug'</span>, <span class="st">'error'</span>, <span class="st">'down'</span>]):</span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>        category <span class="op">=</span> <span class="st">'Technical'</span></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>        category <span class="op">=</span> <span class="st">'General'</span></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sentiment</span></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(word <span class="kw">in</span> text_lower <span class="cf">for</span> word <span class="kw">in</span> [<span class="st">'critical'</span>, <span class="st">'frustrating'</span>, <span class="st">'broken'</span>]):</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>        sentiment <span class="op">=</span> <span class="st">'negative'</span></span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>        sentiment <span class="op">=</span> <span class="st">'neutral'</span></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">'urgency'</span>: urgency,</span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">'category'</span>: category,</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sentiment'</span>: sentiment,</span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'has_exclamation'</span>: <span class="st">'!'</span> <span class="kw">in</span> ticket_text,</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'text_length'</span>: <span class="bu">len</span>(ticket_text)</span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Extract features for all tickets</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Extracting features from tickets...</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>extracted_features <span class="op">=</span> []</span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> text <span class="kw">in</span> df_tickets[<span class="st">'ticket_text'</span>]:</span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_ticket_features(text)</span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>    extracted_features.append(features)</span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>df_features <span class="op">=</span> pd.DataFrame(extracted_features)</span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine with original data</span></span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>df_complete <span class="op">=</span> pd.concat([df_tickets, df_features], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Extracted features:"</span>)</span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_complete[[<span class="st">'ticket_id'</span>, <span class="st">'urgency'</span>, <span class="st">'category'</span>, <span class="st">'sentiment'</span>]].head())</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Encode for ML</span></span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a>le_urgency <span class="op">=</span> LabelEncoder()</span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>le_category <span class="op">=</span> LabelEncoder()</span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>le_sentiment <span class="op">=</span> LabelEncoder()</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a>df_complete[<span class="st">'urgency_encoded'</span>] <span class="op">=</span> le_urgency.fit_transform(df_complete[<span class="st">'urgency'</span>])</span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>df_complete[<span class="st">'category_encoded'</span>] <span class="op">=</span> le_category.fit_transform(df_complete[<span class="st">'category'</span>])</span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>df_complete[<span class="st">'sentiment_encoded'</span>] <span class="op">=</span> le_sentiment.fit_transform(df_complete[<span class="st">'sentiment'</span>])</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>df_complete[<span class="st">'has_exclamation_int'</span>] <span class="op">=</span> df_complete[<span class="st">'has_exclamation'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Train ML model</span></span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>feature_cols <span class="op">=</span> [<span class="st">'urgency_encoded'</span>, <span class="st">'category_encoded'</span>, <span class="st">'sentiment_encoded'</span>,</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>                <span class="st">'has_exclamation_int'</span>, <span class="st">'text_length'</span>]</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df_complete[feature_cols]</span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df_complete[<span class="st">'actual_priority'</span>]</span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: In practice, you'd have more data and do train-test split</span></span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a><span class="co"># This is just a demonstration</span></span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> DecisionTreeClassifier(max_depth<span class="op">=</span><span class="dv">3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>clf.fit(X, y)</span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Make predictions</span></span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>df_complete[<span class="st">'predicted_priority'</span>] <span class="op">=</span> clf.predict(X)</span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Evaluate</span></span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">Results:"</span>)</span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_complete[[<span class="st">'ticket_id'</span>, <span class="st">'actual_priority'</span>, <span class="st">'predicted_priority'</span>]])</span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> (df_complete[<span class="st">'actual_priority'</span>] <span class="op">==</span> df_complete[<span class="st">'predicted_priority'</span>]).mean()</span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.1%}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extracting features from tickets...

Extracted features:
   ticket_id urgency   category sentiment
0          1    high    Billing   neutral
1          2     low    General   neutral
2          3  medium  Technical  negative
3          4     low    General   neutral
4          5    high  Technical  negative


Results:
   ticket_id actual_priority predicted_priority
0          1            high               high
1          2             low                low
2          3          medium             medium
3          4             low                low
4          5        critical           critical

Accuracy: 100.0%</code></pre>
</div>
</div>
<p>This complete pipeline shows the real workflow: 1. Define extraction prompt/function 2. Extract features from text 3. Validate and convert to DataFrame 4. Encode categorical variables 5. Train ML model on extracted features 6. Evaluate performance</p>
<p>In production, you’d add: - Error handling and retries - Rate limiting - Caching - Logging - Cost tracking - Quality monitoring</p>
<p>But the core pattern remains the same: <strong>text → LLM extraction → features → ML model → predictions</strong>.</p>
<hr>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>LLMs are powerful feature engineering tools that transform unstructured text into structured, ML-ready data. The key advantage is zero-shot learning—you can extract information without training data, just clear prompts. But they’re not magic bullets.</p>
<p>You’ve learned to write effective extraction prompts: clear task descriptions, specific output formats (JSON), few-shot examples when needed, and iterative refinement based on errors. You know how to parse and validate LLM responses, handle malformed JSON, check for invalid categories, and identify when extraction fails.</p>
<p>Cost matters. GPT-3.5 costs $0.0005 per 1K tokens; GPT-4 costs 60x more. For simple extraction on large datasets, that difference is huge. Start with GPT-3.5, upgrade only if quality demands it. Calculate costs before processing thousands of texts. Compare LLM cost to alternatives—sometimes manual labeling or traditional ML is cheaper.</p>
<p>Quality control is critical. Spot-check extractions manually. Calculate accuracy against ground truth. Identify systematic errors and refine prompts. Decide when quality is “good enough” based on task requirements. Perfect extraction isn’t always necessary—remember that LLM features are inputs to ML models, and small errors might not hurt final performance.</p>
<p>Know when to use LLMs versus alternatives. Simple keyword matching works for pattern detection. Traditional ML works when you have labeled data and need very fast inference. LLMs excel at context understanding, handling nuanced language, extracting categories without training, and zero-shot learning. Often, hybrid approaches work best: use simple rules when confident, fall back to LLM for hard cases.</p>
<p>Integration with ML pipelines is straightforward: extract features, convert to DataFrame, encode categorical variables, train traditional ML models. The LLM doesn’t replace your ML workflow—it enhances it by creating better features from text.</p>
<p>LLMs are tools, not solutions. They cost money, make mistakes, and sometimes overkill. The skill isn’t just using them—it’s knowing when they add value, which model to choose, how to validate output, and how to integrate them into your data science workflow. Use your brain. That’s what it’s there for.</p>
<hr>
</section>
<section id="practice-exercises" class="level2">
<h2 class="anchored" data-anchor-id="practice-exercises">Practice Exercises</h2>
<ol type="1">
<li><p><strong>Prompt Engineering:</strong> Write three different prompts to extract sentiment from movie reviews. Test them on 10 reviews. Which prompt gives the most consistent results? Why?</p></li>
<li><p><strong>Cost Analysis:</strong> Calculate the cost to extract categories from 50,000 product descriptions using GPT-3.5 vs.&nbsp;GPT-4. Assume average description length of 150 characters, prompt of 60 tokens, response of 10 tokens.</p></li>
<li><p><strong>Validation:</strong> Extract job seniority levels (Entry/Mid/Senior) from 20 job postings. Manually label them yourself. Calculate your LLM’s accuracy. Identify which extractions failed and why.</p></li>
<li><p><strong>Complete Pipeline:</strong> Build a pipeline that: (a) extracts sentiment and rating from customer reviews, (b) converts to DataFrame, (c) trains a classifier to predict if review is helpful (&gt;10 votes), (d) evaluates performance.</p></li>
<li><p><strong>Comparison:</strong> Take a simple classification task (e.g., categorizing emails as work/personal/spam). Implement three approaches: (1) keyword matching, (2) LLM extraction, (3) hybrid. Compare accuracy and cost.</p></li>
<li><p><strong>Quality Control:</strong> Extract product categories from 100 product titles. Create a validation function that flags suspicious extractions (e.g., category not in predefined list). How many would need manual review?</p></li>
</ol>
<hr>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="https://platform.openai.com/docs/api-reference">OpenAI API Documentation</a> - Complete API reference and guides</li>
<li><a href="https://docs.anthropic.com/">Anthropic Claude API</a> - Alternative LLM provider with good context windows</li>
<li><a href="https://www.promptingguide.ai/">Prompt Engineering Guide</a> - Comprehensive guide to writing effective prompts</li>
<li><a href="https://python.langchain.com/">LangChain Documentation</a> - Framework for building LLM applications (more advanced)</li>
<li><a href="https://cookbook.openai.com/">OpenAI Cookbook</a> - Practical examples and code snippets</li>
<li><a href="https://platform.openai.com/tokenizer">Token Counting Tool</a> - See how text converts to tokens</li>
<li><a href="https://help.openai.com/en/articles/6654000-best-practices-for-prompt-engineering-with-openai-api">Best Practices for Prompt Engineering</a> - Official OpenAI guide</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/paulsavala\.github\.io\/math-3339-intro-data-science-with-llms\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>